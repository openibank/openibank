<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpeniBank Agent Banking Control Center</title>
    <style>
        :root {
            --bg-0: #060d1b;
            --bg-1: #0d1b33;
            --bg-2: #122444;
            --card: rgba(13, 26, 51, 0.82);
            --card-strong: rgba(10, 21, 41, 0.95);
            --line: rgba(142, 167, 206, 0.22);
            --line-strong: rgba(142, 167, 206, 0.42);
            --text: #e5ecfb;
            --text-muted: #9fb2d4;
            --text-dim: #7d90b3;
            --accent: #20c4b7;
            --accent-2: #1a9eec;
            --gold: #f0ba49;
            --ok: #41d17a;
            --warn: #f1b445;
            --bad: #f0695c;
            --chip: rgba(159, 178, 212, 0.12);
            --shadow: 0 18px 45px rgba(3, 8, 19, 0.45);
            --font-ui: "IBM Plex Sans", "Avenir Next", "Segoe UI", sans-serif;
            --font-head: "Space Grotesk", "IBM Plex Sans", sans-serif;
            --radius: 16px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            min-height: 100%;
        }

        body {
            font-family: var(--font-ui);
            color: var(--text);
            background:
                radial-gradient(circle at 8% 12%, rgba(26, 158, 236, 0.28), transparent 38%),
                radial-gradient(circle at 90% 18%, rgba(32, 196, 183, 0.26), transparent 34%),
                linear-gradient(145deg, var(--bg-0) 0%, var(--bg-1) 48%, var(--bg-2) 100%);
            overflow-x: hidden;
            letter-spacing: 0.01em;
        }

        .grain {
            pointer-events: none;
            position: fixed;
            inset: 0;
            opacity: 0.08;
            background-image: radial-gradient(rgba(255, 255, 255, 0.28) 0.6px, transparent 0.6px);
            background-size: 4px 4px;
            mix-blend-mode: soft-light;
            z-index: 0;
        }

        .shell {
            position: relative;
            z-index: 1;
            max-width: 1580px;
            margin: 0 auto;
            padding: 20px 20px 26px;
        }

        .hero {
            border: 1px solid var(--line);
            border-radius: calc(var(--radius) + 4px);
            background: linear-gradient(135deg, rgba(7, 15, 29, 0.9), rgba(12, 27, 51, 0.88));
            box-shadow: var(--shadow);
            padding: 18px 20px 16px;
            margin-bottom: 12px;
            animation: riseIn 500ms ease-out;
        }

        .hero-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            flex-wrap: wrap;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .brand-mark {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background:
                linear-gradient(160deg, rgba(32, 196, 183, 0.94), rgba(26, 158, 236, 0.92));
            display: grid;
            place-items: center;
            font-size: 0.95rem;
            font-weight: 800;
            color: #031018;
        }

        .brand h1 {
            font-family: var(--font-head);
            font-size: clamp(1.05rem, 2.3vw, 1.5rem);
            letter-spacing: 0.02em;
            font-weight: 700;
        }

        .brand p {
            color: var(--text-muted);
            font-size: 0.84rem;
            margin-top: 2px;
        }

        .version-pill {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.74rem;
            color: var(--text-dim);
            border: 1px solid var(--line);
            border-radius: 999px;
            padding: 4px 10px;
            background: rgba(12, 27, 49, 0.72);
            margin-top: 6px;
        }

        .hero-metrics {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .status-chip {
            border: 1px solid var(--line);
            background: rgba(8, 18, 36, 0.72);
            border-radius: 999px;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.79rem;
            color: var(--text-muted);
            min-height: 34px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-dim);
            box-shadow: none;
            transition: all 180ms ease;
        }

        .status-dot.ok {
            background: var(--ok);
            box-shadow: 0 0 9px rgba(65, 209, 122, 0.75);
        }

        .status-dot.warn {
            background: var(--warn);
            box-shadow: 0 0 8px rgba(241, 180, 69, 0.62);
        }

        .status-dot.bad {
            background: var(--bad);
            box-shadow: 0 0 8px rgba(240, 105, 92, 0.6);
        }

        .tab-bar {
            border: 1px solid var(--line);
            border-radius: 14px;
            background: rgba(9, 18, 36, 0.62);
            display: flex;
            gap: 2px;
            padding: 6px;
            margin-bottom: 16px;
            overflow-x: auto;
        }

        .tab-btn {
            border: 1px solid transparent;
            background: transparent;
            color: var(--text-muted);
            padding: 10px 14px;
            font-size: 0.82rem;
            border-radius: 10px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 160ms ease;
            font-weight: 600;
        }

        .tab-btn:hover {
            border-color: var(--line);
            color: var(--text);
            background: rgba(159, 178, 212, 0.08);
        }

        .tab-btn.active {
            border-color: rgba(32, 196, 183, 0.45);
            background: linear-gradient(125deg, rgba(32, 196, 183, 0.2), rgba(26, 158, 236, 0.2));
            color: #e9fbff;
        }

        .tab-panel {
            display: none;
            animation: tabReveal 220ms ease;
        }

        .tab-panel.active {
            display: block;
        }

        .grid-6 {
            display: grid;
            grid-template-columns: repeat(6, minmax(0, 1fr));
            gap: 10px;
            margin-bottom: 14px;
        }

        .grid-4 {
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            gap: 10px;
            margin-bottom: 14px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 10px;
            margin-bottom: 14px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 12px;
            margin-bottom: 14px;
        }

        .grid-2-1 {
            display: grid;
            grid-template-columns: 1.9fr 1fr;
            gap: 12px;
            margin-bottom: 14px;
        }

        .card {
            border: 1px solid var(--line);
            background: var(--card);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            backdrop-filter: blur(6px);
        }

        .card-head {
            border-bottom: 1px solid var(--line);
            padding: 13px 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .card-title {
            font-family: var(--font-head);
            font-size: 0.96rem;
            font-weight: 600;
            letter-spacing: 0.015em;
        }

        .card-sub {
            font-size: 0.74rem;
            color: var(--text-dim);
            margin-top: 2px;
        }

        .card-body {
            padding: 13px 14px 14px;
        }

        .metric {
            border: 1px solid var(--line);
            border-radius: 14px;
            background: linear-gradient(145deg, rgba(10, 20, 39, 0.92), rgba(15, 29, 56, 0.86));
            padding: 12px;
            min-height: 90px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 6px;
        }

        .metric-label {
            color: var(--text-dim);
            font-size: 0.72rem;
            letter-spacing: 0.06em;
            text-transform: uppercase;
            font-weight: 600;
        }

        .metric-value {
            font-family: var(--font-head);
            font-size: clamp(1.02rem, 1.5vw, 1.35rem);
            font-weight: 700;
            letter-spacing: 0.01em;
        }

        .metric-note {
            font-size: 0.74rem;
            color: var(--text-muted);
        }

        .metric.accent .metric-value { color: var(--accent); }
        .metric.blue .metric-value { color: #7cc4ff; }
        .metric.gold .metric-value { color: var(--gold); }
        .metric.good .metric-value { color: var(--ok); }
        .metric.warn .metric-value { color: var(--warn); }

        .btn,
        .btn-soft,
        .btn-danger {
            border: 1px solid transparent;
            border-radius: 10px;
            padding: 9px 13px;
            font-size: 0.78rem;
            font-weight: 650;
            cursor: pointer;
            transition: all 140ms ease;
            letter-spacing: 0.02em;
        }

        .btn {
            background: linear-gradient(130deg, rgba(32, 196, 183, 0.92), rgba(26, 158, 236, 0.92));
            color: #05121f;
            border-color: rgba(32, 196, 183, 0.6);
        }

        .btn:hover {
            transform: translateY(-1px);
            filter: brightness(1.05);
        }

        .btn-soft {
            background: rgba(159, 178, 212, 0.1);
            color: var(--text);
            border-color: var(--line);
        }

        .btn-soft:hover {
            background: rgba(159, 178, 212, 0.2);
        }

        .btn-danger {
            background: rgba(240, 105, 92, 0.2);
            color: #ffd8d3;
            border-color: rgba(240, 105, 92, 0.45);
        }

        .btn-danger:hover {
            background: rgba(240, 105, 92, 0.3);
        }

        .btn:disabled,
        .btn-soft:disabled,
        .btn-danger:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .chip-group {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .chip {
            border: 1px solid var(--line);
            border-radius: 999px;
            padding: 5px 10px;
            font-size: 0.72rem;
            background: var(--chip);
            color: var(--text-muted);
            cursor: pointer;
            transition: all 140ms ease;
        }

        .chip:hover {
            color: var(--text);
            border-color: var(--line-strong);
        }

        .chip.active {
            background: rgba(32, 196, 183, 0.2);
            border-color: rgba(32, 196, 183, 0.6);
            color: #ccfff8;
        }

        .table-wrap {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 540px;
        }

        th {
            text-align: left;
            padding: 9px 11px;
            font-size: 0.7rem;
            letter-spacing: 0.07em;
            text-transform: uppercase;
            color: var(--text-dim);
            border-bottom: 1px solid var(--line);
            font-weight: 650;
        }

        td {
            padding: 10px 11px;
            font-size: 0.81rem;
            color: var(--text-muted);
            border-bottom: 1px solid rgba(142, 167, 206, 0.13);
            vertical-align: middle;
        }

        tbody tr:hover {
            background: rgba(159, 178, 212, 0.08);
        }

        .row-selectable {
            cursor: pointer;
        }

        .row-selectable.active {
            background: rgba(32, 196, 183, 0.14);
        }

        .mono {
            font-family: "IBM Plex Mono", "Cascadia Code", monospace;
            font-size: 0.75rem;
            color: #bfd1f4;
        }

        .tag {
            display: inline-flex;
            align-items: center;
            border-radius: 999px;
            padding: 3px 9px;
            font-size: 0.67rem;
            font-weight: 650;
            border: 1px solid transparent;
            white-space: nowrap;
        }

        .tag.role-buyer { background: rgba(26, 158, 236, 0.2); color: #95d2ff; border-color: rgba(26, 158, 236, 0.45); }
        .tag.role-seller { background: rgba(65, 209, 122, 0.2); color: #bcffd2; border-color: rgba(65, 209, 122, 0.45); }
        .tag.role-arbiter { background: rgba(240, 186, 73, 0.2); color: #ffe6af; border-color: rgba(240, 186, 73, 0.45); }

        .tag.pres-idle { background: rgba(159, 178, 212, 0.18); color: #dbe6ff; border-color: rgba(159, 178, 212, 0.45); }
        .tag.pres-trading { background: rgba(65, 209, 122, 0.22); color: #bfffce; border-color: rgba(65, 209, 122, 0.45); }
        .tag.pres-thinkingllm { background: rgba(241, 180, 69, 0.23); color: #ffe4ad; border-color: rgba(241, 180, 69, 0.45); }
        .tag.pres-waitingescrow { background: rgba(124, 196, 255, 0.22); color: #d8efff; border-color: rgba(124, 196, 255, 0.45); }
        .tag.pres-resolvingdispute { background: rgba(240, 105, 92, 0.21); color: #ffd2cd; border-color: rgba(240, 105, 92, 0.45); }
        .tag.pres-suspended { background: rgba(240, 105, 92, 0.28); color: #ffd7d1; border-color: rgba(240, 105, 92, 0.6); }

        .tag.risk-low { background: rgba(65, 209, 122, 0.2); color: #bcffd2; border-color: rgba(65, 209, 122, 0.45); }
        .tag.risk-medium { background: rgba(241, 180, 69, 0.2); color: #ffe6af; border-color: rgba(241, 180, 69, 0.45); }
        .tag.risk-high { background: rgba(240, 105, 92, 0.21); color: #ffd2cd; border-color: rgba(240, 105, 92, 0.45); }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(12, minmax(0, 1fr));
            gap: 10px;
            align-items: end;
        }

        .field {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .field label {
            font-size: 0.7rem;
            color: var(--text-dim);
            letter-spacing: 0.05em;
            text-transform: uppercase;
            font-weight: 620;
        }

        input,
        select,
        textarea {
            width: 100%;
            border-radius: 10px;
            border: 1px solid var(--line);
            background: rgba(8, 17, 34, 0.9);
            color: var(--text);
            padding: 9px 10px;
            font-family: inherit;
            font-size: 0.82rem;
            transition: border-color 120ms ease;
        }

        textarea {
            min-height: 110px;
            resize: vertical;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: rgba(32, 196, 183, 0.65);
            box-shadow: 0 0 0 2px rgba(32, 196, 183, 0.15);
        }

        .span-2 { grid-column: span 2; }
        .span-3 { grid-column: span 3; }
        .span-4 { grid-column: span 4; }
        .span-5 { grid-column: span 5; }
        .span-6 { grid-column: span 6; }
        .span-7 { grid-column: span 7; }
        .span-8 { grid-column: span 8; }
        .span-9 { grid-column: span 9; }
        .span-12 { grid-column: span 12; }

        .liquidity-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .liquidity-item {
            border: 1px solid rgba(142, 167, 206, 0.2);
            border-radius: 10px;
            padding: 10px;
            background: rgba(8, 17, 33, 0.86);
        }

        .liq-top {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 8px;
            align-items: baseline;
        }

        .liq-name {
            font-size: 0.82rem;
            font-weight: 650;
            color: var(--text);
        }

        .liq-meta {
            font-size: 0.7rem;
            color: var(--text-dim);
            margin-top: 2px;
        }

        .liq-value {
            font-family: var(--font-head);
            font-size: 0.86rem;
            color: #d5ffec;
            white-space: nowrap;
        }

        .bar-track {
            height: 8px;
            border-radius: 999px;
            background: rgba(159, 178, 212, 0.16);
            overflow: hidden;
        }

        .bar-fill {
            height: 100%;
            border-radius: inherit;
            background: linear-gradient(90deg, rgba(32, 196, 183, 0.95), rgba(26, 158, 236, 0.95));
            width: 0%;
            transition: width 260ms ease;
        }

        .chart-wrap {
            border: 1px solid rgba(142, 167, 206, 0.2);
            border-radius: 12px;
            background: rgba(8, 18, 36, 0.8);
            min-height: 140px;
            padding: 10px;
        }

        .chart-meta {
            margin-top: 8px;
            font-size: 0.72rem;
            color: var(--text-dim);
        }

        .chart-svg {
            width: 100%;
            height: 120px;
            display: block;
        }

        .stack-track {
            width: 100%;
            height: 12px;
            border-radius: 999px;
            overflow: hidden;
            background: rgba(159, 178, 212, 0.14);
            display: flex;
        }

        .stack-segment {
            height: 100%;
            min-width: 2px;
            transition: width 200ms ease;
        }

        .legend-list {
            margin-top: 8px;
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 6px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.72rem;
            color: var(--text-muted);
        }

        .legend-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        .agent-action-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 8px;
            margin-top: 10px;
        }

        .agent-action-row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .small-note {
            margin-top: 8px;
            font-size: 0.7rem;
            color: var(--text-dim);
            line-height: 1.35;
        }

        .event-feed {
            max-height: 370px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding-right: 2px;
        }

        .event-item {
            border-left: 3px solid var(--line-strong);
            border-radius: 10px;
            background: rgba(8, 18, 36, 0.84);
            padding: 8px 10px;
            display: grid;
            gap: 2px;
            animation: eventPulse 210ms ease;
        }

        .event-item.trade { border-left-color: rgba(65, 209, 122, 0.85); }
        .event-item.risk { border-left-color: rgba(240, 105, 92, 0.85); }
        .event-item.ai { border-left-color: rgba(241, 180, 69, 0.85); }
        .event-item.maple { border-left-color: rgba(124, 196, 255, 0.85); }
        .event-item.system { border-left-color: rgba(159, 178, 212, 0.85); }

        .event-head {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            gap: 12px;
        }

        .event-kind {
            text-transform: uppercase;
            letter-spacing: 0.07em;
            font-size: 0.63rem;
            color: var(--text-dim);
            font-weight: 650;
        }

        .event-time {
            font-size: 0.66rem;
            color: var(--text-dim);
            font-family: "IBM Plex Mono", "Cascadia Code", monospace;
            white-space: nowrap;
        }

        .event-msg {
            font-size: 0.8rem;
            color: var(--text-muted);
            line-height: 1.4;
        }

        .empty {
            border: 1px dashed rgba(142, 167, 206, 0.3);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            color: var(--text-dim);
            font-size: 0.8rem;
            background: rgba(8, 18, 36, 0.58);
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 8px;
            margin-bottom: 10px;
        }

        .detail-cell {
            border: 1px solid rgba(142, 167, 206, 0.2);
            border-radius: 10px;
            background: rgba(8, 18, 36, 0.78);
            padding: 8px 10px;
        }

        .detail-label {
            font-size: 0.66rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.06em;
            margin-bottom: 4px;
        }

        .detail-value {
            font-size: 0.8rem;
            color: var(--text);
            font-weight: 620;
        }

        .activity-list {
            max-height: 260px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 7px;
            margin-top: 8px;
        }

        .trace-list {
            max-height: 220px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 7px;
            margin-top: 8px;
        }

        .trace-item {
            border: 1px dashed rgba(142, 167, 206, 0.2);
            border-radius: 10px;
            padding: 8px 10px;
            background: rgba(12, 24, 46, 0.8);
        }

        .trace-stage {
            font-size: 0.66rem;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            color: #79f2c0;
            font-weight: 650;
        }

        .trace-desc {
            font-size: 0.78rem;
            color: var(--text-muted);
            line-height: 1.35;
        }

        .activity-item {
            border: 1px solid rgba(142, 167, 206, 0.2);
            border-radius: 10px;
            padding: 8px 10px;
            background: rgba(8, 18, 36, 0.8);
        }

        .activity-row {
            display: flex;
            justify-content: space-between;
            gap: 8px;
            margin-bottom: 4px;
            align-items: baseline;
        }

        .activity-cat {
            font-size: 0.66rem;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            color: #8bc4f8;
            font-weight: 650;
        }

        .activity-desc {
            font-size: 0.78rem;
            color: var(--text-muted);
            line-height: 1.35;
        }

        .flash {
            margin-bottom: 12px;
            border-radius: 12px;
            border: 1px solid var(--line);
            padding: 9px 12px;
            background: rgba(8, 18, 36, 0.8);
            color: var(--text-muted);
            font-size: 0.8rem;
            min-height: 39px;
            display: flex;
            align-items: center;
            opacity: 0;
            transform: translateY(-4px);
            pointer-events: none;
            transition: all 150ms ease;
        }

        .flash.show {
            opacity: 1;
            transform: translateY(0);
        }

        .flash.ok {
            border-color: rgba(65, 209, 122, 0.55);
            color: #d9ffe7;
        }

        .flash.warn {
            border-color: rgba(241, 180, 69, 0.55);
            color: #ffefc8;
        }

        .flash.bad {
            border-color: rgba(240, 105, 92, 0.55);
            color: #ffd8d4;
        }

        .footer {
            margin-top: 16px;
            text-align: center;
            color: var(--text-dim);
            font-size: 0.74rem;
            padding: 14px;
            border-top: 1px solid rgba(142, 167, 206, 0.2);
        }

        .footer a {
            color: #a9ddff;
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        .nowrap {
            white-space: nowrap;
        }

        .text-ok { color: var(--ok); }
        .text-warn { color: var(--warn); }
        .text-bad { color: var(--bad); }
        .text-muted { color: var(--text-dim); }
        .strong { color: var(--text); font-weight: 650; }

        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(142, 167, 206, 0.4);
            border-radius: 999px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        @keyframes riseIn {
            from { opacity: 0; transform: translateY(-8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes tabReveal {
            from { opacity: 0.35; transform: translateY(4px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes eventPulse {
            from { opacity: 0; transform: translateY(-3px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 1320px) {
            .grid-6 {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }

            .grid-4 {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }

            .grid-2-1 {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 980px) {
            .shell {
                padding: 14px 12px 18px;
            }

            .hero {
                padding: 14px;
            }

            .grid-3,
            .grid-2,
            .grid-4,
            .grid-6 {
                grid-template-columns: 1fr;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .agent-action-grid {
                grid-template-columns: 1fr;
            }

            .legend-list {
                grid-template-columns: 1fr;
            }

            .span-2,
            .span-3,
            .span-4,
            .span-5,
            .span-6,
            .span-7,
            .span-8,
            .span-9,
            .span-12 {
                grid-column: span 1;
            }

            table {
                min-width: 460px;
            }
        }
    </style>
</head>
<body>
    <div class="grain"></div>
    <div class="shell">
        <header class="hero">
            <div class="hero-row">
                <div class="brand">
                    <div class="brand-mark">OB</div>
                    <div>
                        <h1>OpeniBank Agent Banking Control Center</h1>
                        <p>Multi-tab treasury, risk, and simulation cockpit for autonomous finance agents.</p>
                        <div class="version-pill">
                            <span>Version</span>
                            <span id="sysVersion">0.1.0</span>
                        </div>
                    </div>
                </div>
                <div class="hero-metrics">
                    <div class="status-chip"><span class="status-dot" id="dotConnection"></span><span id="txtConnection">Connecting...</span></div>
                    <div class="status-chip"><span class="status-dot" id="dotRuntime"></span><span id="txtRuntime">Runtime pending</span></div>
                    <div class="status-chip"><span class="status-dot" id="dotLLM"></span><span id="txtLLM">LLM pending</span></div>
                    <div class="status-chip"><span id="txtUptime">Uptime 0s</span></div>
                </div>
            </div>
        </header>

        <div id="flashBanner" class="flash">System ready.</div>

        <nav class="tab-bar" id="tabBar">
            <button class="tab-btn active" data-tab="dashboard">Dashboard</button>
            <button class="tab-btn" data-tab="agents">Agent Status</button>
            <button class="tab-btn" data-tab="operations">Trade Operations</button>
            <button class="tab-btn" data-tab="treasury">Treasury and Ledger</button>
            <button class="tab-btn" data-tab="audit">Audit and Governance</button>
            <button class="tab-btn" data-tab="simulation">Simulation Lab</button>
        </nav>

        <main>
            <section class="tab-panel active" id="tab-dashboard">
                <div class="grid-6">
                    <article class="metric accent">
                        <div class="metric-label">Total Agents</div>
                        <div class="metric-value" id="kpiAgents">0</div>
                        <div class="metric-note" id="kpiAgentsSplit">0 buyers / 0 sellers</div>
                    </article>
                    <article class="metric good">
                        <div class="metric-label">Trades Settled</div>
                        <div class="metric-value" id="kpiTrades">0</div>
                        <div class="metric-note" id="kpiSuccessRate">Success 0%</div>
                    </article>
                    <article class="metric gold">
                        <div class="metric-label">Total Volume</div>
                        <div class="metric-value" id="kpiVolume">$0.00</div>
                        <div class="metric-note" id="kpiAvgTicket">Avg ticket $0.00</div>
                    </article>
                    <article class="metric blue">
                        <div class="metric-label">IUSD Supply</div>
                        <div class="metric-value" id="kpiSupply">$0.00</div>
                        <div class="metric-note" id="kpiSupplyRemaining">Remaining $0.00</div>
                    </article>
                    <article class="metric">
                        <div class="metric-label">Active Couplings</div>
                        <div class="metric-value" id="kpiCouplings">0</div>
                        <div class="metric-note" id="kpiCommitments">Commitments 0</div>
                    </article>
                    <article class="metric">
                        <div class="metric-label">Runtime Health</div>
                        <div class="metric-value" id="kpiRuntime">Idle</div>
                        <div class="metric-note" id="kpiRuntimeNote">Uptime 0s</div>
                    </article>
                </div>

                <div class="grid-3">
                    <article class="card">
                        <div class="card-head">
                            <div>
                                <div class="card-title">Volume Momentum</div>
                                <div class="card-sub">Recent trade amounts across the latest settlements.</div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="chart-wrap" id="chartVolumeTrend"></div>
                            <div class="chart-meta" id="chartVolumeMeta">No trade data yet.</div>
                        </div>
                    </article>

                    <article class="card">
                        <div class="card-head">
                            <div>
                                <div class="card-title">Balance Distribution</div>
                                <div class="card-sub">Top agent wallet balances right now.</div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="chart-wrap" id="chartBalanceSpread"></div>
                            <div class="chart-meta" id="chartBalanceMeta">No balances yet.</div>
                        </div>
                    </article>

                    <article class="card">
                        <div class="card-head">
                            <div>
                                <div class="card-title">Presence Mix</div>
                                <div class="card-sub">Current agent state split and operational posture.</div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="chart-wrap" id="chartPresenceMix"></div>
                            <div class="chart-meta" id="chartPresenceMeta">No presence data yet.</div>
                        </div>
                    </article>
                </div>

                <div class="grid-2-1">
                    <article class="card">
                        <div class="card-head">
                            <div>
                                <div class="card-title">Agent Liquidity Board</div>
                                <div class="card-sub">Balance depth, trade activity, and risk posture by agent.</div>
                            </div>
                            <button class="btn-soft" id="btnRefreshDashboard">Refresh</button>
                        </div>
                        <div class="card-body">
                            <div class="liquidity-list" id="dashboardAgentBoard">
                                <div class="empty">No agents yet. Add agents in Agent Status or run a simulation.</div>
                            </div>
                        </div>
                    </article>

                    <article class="card">
                        <div class="card-head">
                            <div>
                                <div class="card-title">Maple Risk Controls</div>
                                <div class="card-sub">Invariant and commitment gate posture.</div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="detail-grid">
                                <div class="detail-cell"><div class="detail-label">Fail-Closed</div><div class="detail-value" id="riskFailClosed">Unknown</div></div>
                                <div class="detail-cell"><div class="detail-label">No Human Profiles</div><div class="detail-value" id="riskNoHuman">Unknown</div></div>
                                <div class="detail-cell"><div class="detail-label">Pending Reviews</div><div class="detail-value" id="riskPending">0</div></div>
                                <div class="detail-cell"><div class="detail-label">Exec Success</div><div class="detail-value" id="riskExecSuccess">0%</div></div>
                                <div class="detail-cell"><div class="detail-label">Couplings Active</div><div class="detail-value" id="riskCouplings">0</div></div>
                                <div class="detail-cell"><div class="detail-label">Reserve Remaining</div><div class="detail-value" id="riskReserve">$0.00</div></div>
                            </div>
                            <div class="empty" id="runtimeFeatureSummary">Runtime features are loading...</div>
                        </div>
                    </article>
                </div>

                <div class="grid-2">
                    <article class="card">
                        <div class="card-head">
                            <div>
                                <div class="card-title">Live Execution Tape</div>
                                <div class="card-sub">Real-time events from trading, governance, and runtime signals.</div>
                            </div>
                            <div class="chip-group" id="dashboardEventFilters">
                                <button class="chip active" data-filter="all">All</button>
                                <button class="chip" data-filter="trade">Trade</button>
                                <button class="chip" data-filter="risk">Risk</button>
                                <button class="chip" data-filter="ai">AI</button>
                                <button class="chip" data-filter="maple">Maple</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="event-feed" id="dashboardEventFeed">
                                <div class="empty">Waiting for events...</div>
                            </div>
                        </div>
                    </article>

                    <article class="card">
                        <div class="card-head">
                            <div>
                                <div class="card-title">System Posture</div>
                                <div class="card-sub">Quick command controls and mode indicators.</div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="detail-grid" style="margin-bottom:12px;">
                                <div class="detail-cell"><div class="detail-label">LLM Provider</div><div class="detail-value" id="sysLlmProvider">-</div></div>
                                <div class="detail-cell"><div class="detail-label">Runtime Profile</div><div class="detail-value" id="sysRuntimeProfile">-</div></div>
                                <div class="detail-cell"><div class="detail-label">Resonators</div><div class="detail-value" id="sysResonators">0 / 0</div></div>
                                <div class="detail-cell"><div class="detail-label">Last Refresh</div><div class="detail-value" id="sysLastRefresh">-</div></div>
                            </div>
                            <div class="button-group">
                                <button class="btn" id="btnJumpSimulation">Run Simulation</button>
                                <button class="btn-soft" id="btnJumpOps">Open Trade Ops</button>
                                <button class="btn-soft" id="btnDashboardReceiptBundle">Receipt Bundle</button>
                                <button class="btn-danger" id="btnResetFromDash">Reset System</button>
                            </div>
                        </div>
                    </article>
                </div>
            </section>

            <section class="tab-panel" id="tab-agents">
                <div class="grid-4">
                    <article class="metric accent"><div class="metric-label">Agents</div><div class="metric-value" id="agentTotalCount">0</div><div class="metric-note">Registered identities</div></article>
                    <article class="metric blue"><div class="metric-label">Buyers</div><div class="metric-value" id="agentBuyerCount">0</div><div class="metric-note">Demand side</div></article>
                    <article class="metric good"><div class="metric-label">Sellers</div><div class="metric-value" id="agentSellerCount">0</div><div class="metric-note">Supply side</div></article>
                    <article class="metric warn"><div class="metric-label">Suspended</div><div class="metric-value" id="agentSuspendedCount">0</div><div class="metric-note">Needs intervention</div></article>
                </div>

                <div class="grid-2-1">
                    <article class="card">
                        <div class="card-head">
                            <div>
                                <div class="card-title">Agent Status Matrix</div>
                                <div class="card-sub">Presence, balance, services, and risk per agent.</div>
                            </div>
                            <button class="btn-soft" id="btnRefreshAgents">Refresh</button>
                        </div>
                        <div class="card-body">
                            <div class="table-wrap">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Agent</th>
                                            <th>Role</th>
                                            <th>Presence</th>
                                            <th>Balance</th>
                                            <th>Trades</th>
                                            <th>Service</th>
                                            <th>Risk</th>
                                            <th>Priority</th>
                                        </tr>
                                    </thead>
                                    <tbody id="agentStatusTable">
                                        <tr><td colspan="8" class="empty">No agents loaded.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </article>

                    <article class="card">
                        <div class="card-head">
                            <div>
                                <div class="card-title">Selected Agent Detail</div>
                                <div class="card-sub">Operational profile and recent activity.</div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="detail-grid">
                                <div class="detail-cell"><div class="detail-label">Name</div><div class="detail-value" id="agentDetailName">-</div></div>
                                <div class="detail-cell"><div class="detail-label">ID</div><div class="detail-value mono" id="agentDetailId">-</div></div>
                                <div class="detail-cell"><div class="detail-label">Role</div><div class="detail-value" id="agentDetailRole">-</div></div>
                                <div class="detail-cell"><div class="detail-label">Presence</div><div class="detail-value" id="agentDetailPresence">-</div></div>
                                <div class="detail-cell"><div class="detail-label">Balance</div><div class="detail-value" id="agentDetailBalance">-</div></div>
                                <div class="detail-cell"><div class="detail-label">LLM Model</div><div class="detail-value" id="agentDetailLlm">-</div></div>
                            </div>
                            <div class="detail-cell" style="margin-bottom:8px;">
                                <div class="detail-label">Service Catalog</div>
                                <div class="detail-value" id="agentDetailServices">-</div>
                            </div>
                            <div class="detail-cell">
                                <div class="detail-label">Action Panel</div>
                                <div class="agent-action-grid">
                                    <div class="field">
                                        <label for="agentFundAmount">Top-Up (USD)</label>
                                        <input id="agentFundAmount" type="number" min="1" value="100">
                                    </div>
                                    <div class="field">
                                        <label for="agentPriorityOverride">Priority Override</label>
                                        <select id="agentPriorityOverride">
                                            <option value="normal">Normal</option>
                                            <option value="high">High</option>
                                            <option value="critical">Critical</option>
                                            <option value="low">Low</option>
                                        </select>
                                    </div>
                                    <div class="field">
                                        <label for="agentRiskOverride">Risk Override</label>
                                        <select id="agentRiskOverride">
                                            <option value="auto">Auto</option>
                                            <option value="low">Low</option>
                                            <option value="medium">Medium</option>
                                            <option value="high">High</option>
                                        </select>
                                    </div>
                                    <div class="field">
                                        <label for="agentDetailOverrideState">Override State</label>
                                        <div class="detail-value" id="agentDetailOverrideState">Auto</div>
                                    </div>
                                </div>
                                <div class="agent-action-row">
                                    <button class="btn" id="btnFundSelected">Fund Agent</button>
                                    <button class="btn-soft" id="btnSuspendSelected">Suspend</button>
                                    <button class="btn-soft" id="btnResumeSelected">Resume</button>
                                    <button class="btn-soft" id="btnSaveAgentOverride">Save Overrides</button>
                                </div>
                                <div class="small-note">
                                    Funding mints reserve-backed IUSD and updates the selected agent wallet.
                                    Priority and risk overrides are local operator controls for this dashboard.
                                </div>
                            </div>
                            <div class="detail-label">Recent Agent Activity</div>
                            <div class="activity-list" id="agentActivityList">
                                <div class="empty">Select an agent to inspect activity.</div>
                            </div>
                            <div class="detail-label">Kernel Trace</div>
                            <div class="agent-action-row">
                                <button class="btn-soft" id="btnDownloadKernelTrace">Download Trace</button>
                                <div class="small-note" id="agentTraceStatus">Select an agent to load kernel trace.</div>
                            </div>
                            <div class="trace-list" id="agentTraceList">
                                <div class="empty">Select an agent to inspect kernel trace.</div>
                            </div>
                        </div>
                    </article>
                </div>

                <div class="grid-2">
                    <article class="card">
                        <div class="card-head">
                            <div>
                                <div class="card-title">Create Buyer Agent</div>
                                <div class="card-sub">Initialize funded demand-side agents.</div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="form-grid">
                                <div class="field span-7">
                                    <label for="inBuyerName">Buyer Name</label>
                                    <input id="inBuyerName" type="text" placeholder="Atlas Procurement Bot">
                                </div>
                                <div class="field span-3">
                                    <label for="inBuyerFunding">Funding (USD)</label>
                                    <input id="inBuyerFunding" type="number" min="1" value="500">
                                </div>
                                <div class="field span-2">
                                    <button class="btn" id="btnCreateBuyer">Create Buyer</button>
                                </div>
                            </div>
                        </div>
                    </article>

                    <article class="card">
                        <div class="card-head">
                            <div>
                                <div class="card-title">Create Seller Agent</div>
                                <div class="card-sub">Register service-side supply agents.</div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="form-grid">
                                <div class="field span-4">
                                    <label for="inSellerName">Seller Name</label>
                                    <input id="inSellerName" type="text" placeholder="Vertex Analytics">
                                </div>
                                <div class="field span-4">
                                    <label for="inServiceName">Service</label>
                                    <input id="inServiceName" type="text" placeholder="Fraud Detection API">
                                </div>
                                <div class="field span-2">
                                    <label for="inServicePrice">Price (USD)</label>
                                    <input id="inServicePrice" type="number" min="1" value="75">
                                </div>
                                <div class="field span-2">
                                    <button class="btn" id="btnCreateSeller">Create Seller</button>
                                </div>
                            </div>
                        </div>
                    </article>
                </div>
            </section>

            <section class="tab-panel" id="tab-operations">
                <div class="grid-2">
                    <article class="card">
                        <div class="card-head">
                            <div>
                                <div class="card-title">Manual Trade Ticket</div>
                                <div class="card-sub">Select buyer and seller to execute settlement workflow.</div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="form-grid">
                                <div class="field span-5">
                                    <label for="tradeBuyer">Buyer</label>
                                    <select id="tradeBuyer"><option value="">Select buyer</option></select>
                                </div>
                                <div class="field span-5">
                                    <label for="tradeSeller">Seller</label>
                                    <select id="tradeSeller"><option value="">Select seller</option></select>
                                </div>
                                <div class="field span-2">
                                    <button class="btn" id="btnExecuteTrade">Execute Trade</button>
                                </div>
                            </div>
                        </div>
                    </article>

                    <article class="card">
                        <div class="card-head">
                            <div>
                                <div class="card-title">Auto Trading Runbook</div>
                                <div class="card-sub">Continuous rounds for stress and throughput testing.</div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="form-grid">
                                <div class="field span-4">
                                    <label for="autoRounds">Rounds</label>
                                    <input id="autoRounds" type="number" min="1" max="500" value="10">
                                </div>
                                <div class="field span-4">
                                    <label for="autoDelay">Delay (ms)</label>
                                    <input id="autoDelay" type="number" min="100" max="10000" value="1000">
                                </div>
                                <div class="field span-4">
                                    <label>Action</label>
                                    <button class="btn" id="btnAutoTrade">Start Auto Trading</button>
                                </div>
                            </div>
                        </div>
                    </article>
                </div>

                <div class="grid-3">
                    <article class="metric"><div class="metric-label">Active Couplings</div><div class="metric-value" id="opsCouplingActive">0</div><div class="metric-note" id="opsCouplingTotal">Total 0</div></article>
                    <article class="metric"><div class="metric-label">Commitments</div><div class="metric-value" id="opsCommitTotal">0</div><div class="metric-note" id="opsCommitPending">Pending 0</div></article>
                    <article class="metric"><div class="metric-label">Execution Success</div><div class="metric-value" id="opsExecSuccess">0%</div><div class="metric-note" id="opsExecCounts">0 success / 0 fail</div></article>
                </div>

                <div class="grid-2">
                    <article class="card">
                        <div class="card-head">
                            <div>
                                <div class="card-title">Trade Blotter</div>
                                <div class="card-sub">Most recent transactions and settlement state.</div>
                            </div>
                            <div class="button-group">
                                <span class="status-chip">Count <span id="txCount">0</span></span>
                                <button class="btn-soft" id="btnRefreshTrades">Refresh</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-wrap">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Trade ID</th>
                                            <th>Buyer</th>
                                            <th>Seller</th>
                                            <th>Service</th>
                                            <th>Amount</th>
                                            <th>Status</th>
                                            <th>Time</th>
                                        </tr>
                                    </thead>
                                    <tbody id="txTable">
                                        <tr><td colspan="7" class="empty">No transactions yet.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </article>

                    <article class="card">
                        <div class="card-head">
                            <div>
                                <div class="card-title">Recent Commitments</div>
                                <div class="card-sub">AAS pipeline records from the Maple commitment manager.</div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-wrap">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Commitment</th>
                                            <th>Buyer</th>
                                            <th>Seller</th>
                                            <th>Amount</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="commitmentTable">
                                        <tr><td colspan="5" class="empty">No commitment records yet.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </article>
                </div>
            </section>

            <section class="tab-panel" id="tab-treasury">
                <div class="grid-4">
                    <article class="metric blue"><div class="metric-label">Total Minted</div><div class="metric-value" id="supplyTotal">$0.00</div><div class="metric-note">IUSD outstanding</div></article>
                    <article class="metric good"><div class="metric-label">Remaining Capacity</div><div class="metric-value" id="supplyRemaining">$0.00</div><div class="metric-note">Mint reserve left</div></article>
                    <article class="metric accent"><div class="metric-label">Issuer Receipts</div><div class="metric-value" id="supplyReceipts">0</div><div class="metric-note">Proof documents</div></article>
                    <article class="metric gold"><div class="metric-label">Ledger Entries</div><div class="metric-value" id="entryCount">0</div><div class="metric-note">Recent entry window</div></article>
                </div>

                <div class="grid-2">
                    <article class="card">
                        <div class="card-head">
                            <div>
                                <div class="card-title">Ledger Accounts</div>
                                <div class="card-sub">Current balances per account.</div>
                            </div>
                            <button class="btn-soft" id="btnRefreshLedger">Refresh</button>
                        </div>
                        <div class="card-body">
                            <div class="table-wrap">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Account</th>
                                            <th>Balance</th>
                                        </tr>
                                    </thead>
                                    <tbody id="ledgerAccounts">
                                        <tr><td colspan="2" class="empty">No accounts available.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </article>

                    <article class="card">
                        <div class="card-head">
                            <div>
                                <div class="card-title">Recent Ledger Entries</div>
                                <div class="card-sub">Latest credit and debit operations.</div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-wrap">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Type</th>
                                            <th>Account</th>
                                            <th>Amount</th>
                                            <th>Balance After</th>
                                            <th>Reason</th>
                                        </tr>
                                    </thead>
                                    <tbody id="ledgerEntries">
                                        <tr><td colspan="5" class="empty">No ledger entries yet.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </article>
                </div>

                <article class="card">
                    <div class="card-head">
                        <div>
                            <div class="card-title">Issuer Receipt Registry</div>
                            <div class="card-sub">Mint and supply receipts from issuer operations.</div>
                        </div>
                        <div class="button-group">
                            <span class="status-chip">Count <span id="receiptCount">0</span></span>
                            <button class="btn-soft" id="btnRefreshReceipts">Refresh</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-wrap">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Receipt ID</th>
                                        <th>Operation</th>
                                        <th>Target</th>
                                        <th>Amount</th>
                                        <th>Issued At</th>
                                    </tr>
                                </thead>
                                <tbody id="receiptTable">
                                    <tr><td colspan="5" class="empty">No issuer receipts yet.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </article>
            </section>

            <section class="tab-panel" id="tab-audit">
                <div class="grid-2">
                    <article class="card">
                        <div class="card-head">
                            <div>
                                <div class="card-title">System Activity Log</div>
                                <div class="card-sub">Cross-service events with source and severity.</div>
                            </div>
                            <div class="chip-group" id="activityFilters">
                                <button class="chip active" data-filter="all">All</button>
                                <button class="chip" data-filter="Trade">Trade</button>
                                <button class="chip" data-filter="AgentLifecycle">Agents</button>
                                <button class="chip" data-filter="Issuer">Issuer</button>
                                <button class="chip" data-filter="LLM">LLM</button>
                                <button class="chip" data-filter="Error">Error</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-wrap">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Time</th>
                                            <th>Level</th>
                                            <th>Category</th>
                                            <th>Source</th>
                                            <th>Description</th>
                                        </tr>
                                    </thead>
                                    <tbody id="activityTable">
                                        <tr><td colspan="5" class="empty">No activity entries yet.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </article>

                    <article class="card">
                        <div class="card-head">
                            <div>
                                <div class="card-title">Event Stream Inspector</div>
                                <div class="card-sub">Low-latency feed of SSE event categories.</div>
                            </div>
                            <div class="chip-group" id="auditEventFilters">
                                <button class="chip active" data-filter="all">All</button>
                                <button class="chip" data-filter="trade">Trade</button>
                                <button class="chip" data-filter="risk">Risk</button>
                                <button class="chip" data-filter="ai">AI</button>
                                <button class="chip" data-filter="system">System</button>
                                <button class="chip" data-filter="maple">Maple</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="event-feed" id="auditEventFeed">
                                <div class="empty">Waiting for stream events...</div>
                            </div>
                        </div>
                    </article>
                </div>

                <div class="grid-2">
                    <article class="card">
                        <div class="card-head">
                            <div>
                                <div class="card-title">UAL Command Workbench</div>
                                <div class="card-sub">Compile UAL statements or parse banking commands.</div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="field" style="margin-bottom:10px;">
                                <label for="ualCommand">UAL / Banking Command</label>
                                <textarea id="ualCommand" placeholder="Try: STATUS&#10;Try: UAL COMMIT buyer:res_alice -> seller:res_datacorp amount:10000"></textarea>
                            </div>
                            <div class="button-group" style="margin-bottom:10px;">
                                <button class="btn" id="btnRunUal">Execute</button>
                                <button class="btn-soft" id="btnClearUal">Clear</button>
                            </div>
                            <pre class="mono" id="ualResult" style="white-space:pre-wrap; border:1px solid var(--line); border-radius:10px; background:rgba(8,18,36,0.84); padding:10px; min-height:90px;">Awaiting command...</pre>
                        </div>
                    </article>

                    <article class="card">
                        <div class="card-head">
                            <div>
                                <div class="card-title">System Metadata</div>
                                <div class="card-sub">Build, provider, and architecture details.</div>
                            </div>
                            <button class="btn-soft" id="btnRefreshInfo">Refresh</button>
                        </div>
                        <div class="card-body">
                            <div class="detail-grid">
                                <div class="detail-cell"><div class="detail-label">Name</div><div class="detail-value" id="infoName">-</div></div>
                                <div class="detail-cell"><div class="detail-label">Architecture</div><div class="detail-value" id="infoArchitecture">-</div></div>
                                <div class="detail-cell"><div class="detail-label">Homepage</div><div class="detail-value" id="infoHomepage">-</div></div>
                                <div class="detail-cell"><div class="detail-label">Repository</div><div class="detail-value" id="infoRepository">-</div></div>
                                <div class="detail-cell"><div class="detail-label">LLM Provider</div><div class="detail-value" id="infoLlmProvider">-</div></div>
                                <div class="detail-cell"><div class="detail-label">Started</div><div class="detail-value" id="infoStarted">-</div></div>
                            </div>
                        </div>
                    </article>
                </div>

                <div class="grid-2">
                    <article class="card">
                        <div class="card-head">
                            <div>
                                <div class="card-title">Receipt Timeline</div>
                                <div class="card-sub">Every commitment and issuer receipt in order.</div>
                            </div>
                            <div class="button-group">
                                <button class="btn-soft" id="btnRefreshReceiptTimeline">Refresh</button>
                                <button class="btn-soft" id="btnDownloadReceipts">Download JSONL</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="trace-list" id="receiptTimeline">
                                <div class="empty">No receipts yet.</div>
                            </div>
                        </div>
                    </article>

                    <article class="card">
                        <div class="card-head">
                            <div>
                                <div class="card-title">Receipt Verification & Replay</div>
                                <div class="card-sub">Verify receipts and replay balances from JSONL bundles.</div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="field" style="margin-bottom:10px;">
                                <label for="receiptVerifyInput">Receipt ID</label>
                                <input id="receiptVerifyInput" placeholder="receipt or commitment id" />
                            </div>
                            <div class="button-group" style="margin-bottom:10px;">
                                <button class="btn" id="btnVerifyReceipt">Verify</button>
                                <button class="btn-soft" id="btnClearVerify">Clear</button>
                            </div>
                            <pre class="mono" id="receiptVerifyResult" style="white-space:pre-wrap; border:1px solid var(--line); border-radius:10px; background:rgba(8,18,36,0.84); padding:10px; min-height:80px;">Awaiting receipt...</pre>

                            <div class="field" style="margin-top:14px; margin-bottom:10px;">
                                <label for="receiptReplayInput">Receipt Bundle (JSONL)</label>
                                <textarea id="receiptReplayInput" placeholder="Paste JSONL receipts here or load export"></textarea>
                            </div>
                            <div class="button-group" style="margin-bottom:10px;">
                                <button class="btn" id="btnReplayReceipts">Replay</button>
                                <button class="btn-soft" id="btnLoadReceiptExport">Load Latest</button>
                            </div>
                            <pre class="mono" id="receiptReplayResult" style="white-space:pre-wrap; border:1px solid var(--line); border-radius:10px; background:rgba(8,18,36,0.84); padding:10px; min-height:80px;">Awaiting replay...</pre>
                        </div>
                    </article>
                </div>
            </section>

            <section class="tab-panel" id="tab-simulation">
                <div class="grid-2">
                    <article class="card">
                        <div class="card-head">
                            <div>
                                <div class="card-title">Banking Simulation Builder</div>
                                <div class="card-sub">Provision agents and run autonomous trading rounds.</div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="form-grid" style="margin-bottom:10px;">
                                <div class="field span-12">
                                    <label for="simScenario">Scenario Template</label>
                                    <select id="simScenario">
                                        <option value="baseline">Baseline Marketplace</option>
                                        <option value="burst_demand">Burst Demand</option>
                                        <option value="liquidity_crunch">Liquidity Crunch</option>
                                        <option value="market_shock">Market Shock</option>
                                    </select>
                                </div>
                                <div class="field span-3">
                                    <label for="simBuyers">Buyers</label>
                                    <input id="simBuyers" type="number" min="1" max="20" value="3">
                                </div>
                                <div class="field span-3">
                                    <label for="simSellers">Sellers</label>
                                    <input id="simSellers" type="number" min="1" max="20" value="2">
                                </div>
                                <div class="field span-3">
                                    <label for="simRounds">Rounds</label>
                                    <input id="simRounds" type="number" min="1" max="500" value="10">
                                </div>
                                <div class="field span-3">
                                    <label for="simDelay">Delay (ms)</label>
                                    <input id="simDelay" type="number" min="100" max="10000" value="500">
                                </div>
                            </div>
                            <div class="button-group" style="margin-bottom:10px;">
                                <button class="btn" id="btnRunSimulation">Start Simulation</button>
                                <button class="btn-soft" id="btnApplyScenario">Apply Scenario</button>
                                <button class="btn-soft" id="btnPresetQuick">Preset Quick</button>
                                <button class="btn-soft" id="btnPresetStress">Preset Stress</button>
                                <button class="btn-danger" id="btnResetSystem">Reset Playground</button>
                            </div>
                            <div class="detail-grid">
                                <div class="detail-cell"><div class="detail-label">Simulation State</div><div class="detail-value" id="simState">Idle</div></div>
                                <div class="detail-cell"><div class="detail-label">Last Run</div><div class="detail-value" id="simLastRun">-</div></div>
                                <div class="detail-cell"><div class="detail-label">Config</div><div class="detail-value" id="simLastConfig">-</div></div>
                                <div class="detail-cell"><div class="detail-label">Trade Events</div><div class="detail-value" id="simTradeEvents">0</div></div>
                                <div class="detail-cell"><div class="detail-label">Scenario</div><div class="detail-value" id="simScenarioName">Baseline Marketplace</div></div>
                                <div class="detail-cell"><div class="detail-label">Scenario Notes</div><div class="detail-value" id="simScenarioNotes">Balanced baseline with moderate traffic.</div></div>
                            </div>
                        </div>
                    </article>

                    <article class="card">
                        <div class="card-head">
                            <div>
                                <div class="card-title">Simulation Event Tape</div>
                                <div class="card-sub">Latest simulation-linked event output.</div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="event-feed" id="simEventFeed">
                                <div class="empty">Run a simulation to populate event tape.</div>
                            </div>
                        </div>
                    </article>
                </div>
            </section>
        </main>

        <footer class="footer">
            OpeniBank playground with Maple runtime controls. <a href="https://github.com/openibank/openibank" target="_blank" rel="noreferrer">GitHub</a>
        </footer>
    </div>

    <script>
        const state = {
            tab: "dashboard",
            status: null,
            info: null,
            agents: [],
            resonators: [],
            transactions: [],
            ledger: { accounts: [], total_entries: 0, recent_entries: [] },
            supply: null,
            receipts: [],
            receiptRecords: [],
            activity: [],
            events: [],
            dashboardEventFilter: "all",
            auditEventFilter: "all",
            activityFilter: "all",
            selectedAgentId: null,
            agentActivity: {},
            agentTrace: {},
            agentOverrides: {},
            eventSource: null,
            lastRefreshAt: null,
            refreshTimer: null,
            simulationTimer: null,
            simulation: {
                running: false,
                lastRun: null,
                config: null,
                scenario: "baseline",
            },
        };

        const SSE_EVENTS = [
            "state_sync",
            "agent_created",
            "agent_state_changed",
            "balance_updated",
            "trade_started",
            "trade_completed",
            "trade_failed",
            "commitment_declared",
            "transfer_proposed",
            "transfer_posted",
            "escrow_opened",
            "escrow_released",
            "minted",
            "burned",
            "llm_reasoning",
            "receipt_generated",
            "receipt_issued",
            "receipt_verified",
            "issuer_event",
            "ledger_entry",
            "escrow_event",
            "dispute_event",
            "system_status",
            "system_reset",
            "maple_runtime",
            "coupling_established",
            "coupling_strengthened",
            "coupling_weakened",
            "decoupled",
            "commitment_submitted",
            "commitment_approved",
            "commitment_rejected",
            "commitment_outcome",
            "attention_allocated",
            "attention_exhausted",
            "capability_granted",
            "capability_denied",
        ];

        const SCENARIO_PRESETS = {
            baseline: {
                name: "Baseline Marketplace",
                notes: "Balanced baseline with moderate traffic.",
                buyers: 3,
                sellers: 2,
                rounds: 10,
                delay_ms: 500,
            },
            burst_demand: {
                name: "Burst Demand",
                notes: "Buyer-heavy demand spike with fast rounds.",
                buyers: 9,
                sellers: 3,
                rounds: 60,
                delay_ms: 250,
            },
            liquidity_crunch: {
                name: "Liquidity Crunch",
                notes: "Longer run with constrained throughput.",
                buyers: 4,
                sellers: 4,
                rounds: 120,
                delay_ms: 900,
            },
            market_shock: {
                name: "Market Shock",
                notes: "Supply-demand imbalance and rapid stress cadence.",
                buyers: 2,
                sellers: 7,
                rounds: 90,
                delay_ms: 220,
            },
        };

        document.addEventListener("DOMContentLoaded", () => {
            loadAgentOverrides();
            wireTabs();
            wireActions();
            wireFilters();
            connectSSE();
            applyScenarioPreset("baseline", { silent: true });
            initialLoad();
            setInterval(heartbeatRefresh, 6000);
        });

        function $(id) {
            return document.getElementById(id);
        }

        function setText(id, value) {
            const el = $(id);
            if (el) {
                el.textContent = value;
            }
        }

        function loadAgentOverrides() {
            try {
                const raw = window.localStorage.getItem("openibank_agent_overrides");
                if (!raw) {
                    return;
                }
                const parsed = JSON.parse(raw);
                if (parsed && typeof parsed === "object") {
                    state.agentOverrides = parsed;
                }
            } catch (_) {
                state.agentOverrides = {};
            }
        }

        function persistAgentOverrides() {
            try {
                window.localStorage.setItem(
                    "openibank_agent_overrides",
                    JSON.stringify(state.agentOverrides)
                );
            } catch (_) {}
        }

        function escapeHtml(value) {
            return String(value ?? "")
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/\"/g, "&quot;")
                .replace(/'/g, "&#39;");
        }

        function formatMoney(cents) {
            const n = Number(cents || 0) / 100;
            return n.toLocaleString("en-US", {
                style: "currency",
                currency: "USD",
                minimumFractionDigits: 2,
                maximumFractionDigits: 2,
            });
        }

        function formatNumber(n) {
            return Number(n || 0).toLocaleString("en-US");
        }

        function formatTime(ts) {
            if (!ts) {
                return "-";
            }
            const date = new Date(ts);
            if (Number.isNaN(date.getTime())) {
                return "-";
            }
            return date.toLocaleTimeString();
        }

        function formatDateTime(ts) {
            if (!ts) {
                return "-";
            }
            const date = new Date(ts);
            if (Number.isNaN(date.getTime())) {
                return "-";
            }
            return date.toLocaleString();
        }

        function formatDuration(seconds) {
            const secs = Number(seconds || 0);
            if (secs < 60) {
                return `${secs}s`;
            }
            if (secs < 3600) {
                return `${Math.floor(secs / 60)}m ${secs % 60}s`;
            }
            return `${Math.floor(secs / 3600)}h ${Math.floor((secs % 3600) / 60)}m`;
        }

        function shortId(value, size = 14) {
            if (!value) {
                return "-";
            }
            const text = String(value);
            return text.length <= size ? text : `${text.slice(0, size)}...`;
        }

        function roleClass(role) {
            const key = String(role || "").toLowerCase();
            if (key.includes("buyer")) return "role-buyer";
            if (key.includes("seller")) return "role-seller";
            return "role-arbiter";
        }

        function presenceClass(presence) {
            return `pres-${String(presence || "idle").toLowerCase()}`;
        }

        function defaultRiskFromAgent(agent) {
            const balance = Number(agent?.balance || 0);
            const presence = String(agent?.presence || "Idle");
            const tradeCount = Number(agent?.trade_count || 0);
            if (presence === "Suspended" || balance <= 0) {
                return "high";
            }
            if (balance < 10_000 || tradeCount === 0) {
                return "medium";
            }
            return "low";
        }

        function riskFromAgent(agent) {
            const overrideRisk = state.agentOverrides?.[agent?.id]?.risk;
            if (overrideRisk && overrideRisk !== "auto") {
                return overrideRisk;
            }
            return defaultRiskFromAgent(agent);
        }

        function priorityFromAgent(agent) {
            return state.agentOverrides?.[agent?.id]?.priority || "normal";
        }

        function levelClass(level) {
            const text = String(level || "");
            if (text === "Critical" || text === "Error") {
                return "risk-high";
            }
            if (text === "Warning") {
                return "risk-medium";
            }
            return "risk-low";
        }

        function setDot(id, status) {
            const el = $(id);
            if (!el) {
                return;
            }
            el.className = "status-dot";
            if (status === "ok") {
                el.classList.add("ok");
            } else if (status === "warn") {
                el.classList.add("warn");
            } else if (status === "bad") {
                el.classList.add("bad");
            }
        }

        function flash(message, tone = "ok") {
            const banner = $("flashBanner");
            if (!banner) {
                return;
            }
            banner.textContent = message;
            banner.className = `flash show ${tone}`;
            clearTimeout(state.flashTimer);
            state.flashTimer = setTimeout(() => {
                banner.className = "flash";
            }, 2600);
        }

        async function requestJSON(url, options = undefined) {
            const response = await fetch(url, options);
            let data = {};
            try {
                data = await response.json();
            } catch (_) {
                data = {};
            }
            if (!response.ok) {
                const message = data?.message || data?.error || `Request failed (${response.status})`;
                throw new Error(message);
            }
            return data;
        }

        function wireTabs() {
            document.querySelectorAll("#tabBar .tab-btn").forEach((button) => {
                button.addEventListener("click", () => switchTab(button.dataset.tab));
            });
        }

        function switchTab(tabName) {
            state.tab = tabName;
            document.querySelectorAll("#tabBar .tab-btn").forEach((button) => {
                button.classList.toggle("active", button.dataset.tab === tabName);
            });
            document.querySelectorAll(".tab-panel").forEach((panel) => {
                panel.classList.toggle("active", panel.id === `tab-${tabName}`);
            });
            loadForTab(tabName);
        }

        function wireActions() {
            $("btnRefreshDashboard")?.addEventListener("click", refreshDashboardData);
            $("btnJumpSimulation")?.addEventListener("click", () => switchTab("simulation"));
            $("btnJumpOps")?.addEventListener("click", () => switchTab("operations"));
            $("btnDashboardReceiptBundle")?.addEventListener("click", () => {
                downloadReceipts();
                flash("Receipt bundle export opened.", "ok");
            });
            $("btnResetFromDash")?.addEventListener("click", resetPlayground);

            $("btnRefreshAgents")?.addEventListener("click", async () => {
                await Promise.allSettled([loadAgents(), loadResonators()]);
                renderAgents();
            });

            $("btnCreateBuyer")?.addEventListener("click", createBuyer);
            $("btnCreateSeller")?.addEventListener("click", createSeller);
            $("btnFundSelected")?.addEventListener("click", fundSelectedAgent);
            $("btnDownloadKernelTrace")?.addEventListener("click", downloadKernelTrace);
            $("btnSuspendSelected")?.addEventListener("click", () => setSelectedAgentPresence("suspended"));
            $("btnResumeSelected")?.addEventListener("click", () => setSelectedAgentPresence("idle"));
            $("btnSaveAgentOverride")?.addEventListener("click", saveSelectedAgentOverrides);

            $("btnExecuteTrade")?.addEventListener("click", executeTrade);
            $("btnAutoTrade")?.addEventListener("click", startAutoTrading);
            $("btnRefreshTrades")?.addEventListener("click", async () => {
                await loadTransactions();
                renderOperations();
            });

            $("btnRefreshLedger")?.addEventListener("click", async () => {
                await Promise.allSettled([loadLedger(), loadSupply()]);
                renderTreasury();
            });
            $("btnRefreshReceipts")?.addEventListener("click", async () => {
                await loadReceipts();
                renderTreasury();
            });

            $("btnRunUal")?.addEventListener("click", runUalCommand);
            $("btnClearUal")?.addEventListener("click", () => {
                $("ualCommand").value = "";
                setText("ualResult", "Awaiting command...");
            });
            $("btnRefreshInfo")?.addEventListener("click", async () => {
                await Promise.allSettled([loadInfo(), loadStatus()]);
                renderAudit();
            });
            $("btnRefreshReceiptTimeline")?.addEventListener("click", async () => {
                await loadReceiptRecords();
                renderReceiptTimeline();
            });
            $("btnDownloadReceipts")?.addEventListener("click", downloadReceipts);
            $("btnVerifyReceipt")?.addEventListener("click", verifyReceiptManual);
            $("btnClearVerify")?.addEventListener("click", () => {
                $("receiptVerifyInput").value = "";
                setText("receiptVerifyResult", "Awaiting receipt...");
            });
            $("btnReplayReceipts")?.addEventListener("click", replayReceiptBundle);
            $("btnLoadReceiptExport")?.addEventListener("click", loadReceiptExport);

            $("btnRunSimulation")?.addEventListener("click", runSimulation);
            $("btnApplyScenario")?.addEventListener("click", () => {
                const selected = $("simScenario")?.value || "baseline";
                applyScenarioPreset(selected);
            });
            $("simScenario")?.addEventListener("change", () => {
                const selected = $("simScenario")?.value || "baseline";
                applyScenarioPreset(selected, { silent: true, applyInputs: false });
            });
            $("btnPresetQuick")?.addEventListener("click", () => {
                $("simBuyers").value = 3;
                $("simSellers").value = 2;
                $("simRounds").value = 8;
                $("simDelay").value = 350;
                state.simulation.scenario = "baseline";
                if ($("simScenario")) {
                    $("simScenario").value = "baseline";
                }
                renderSimulation();
                flash("Quick preset loaded.", "ok");
            });
            $("btnPresetStress")?.addEventListener("click", () => {
                $("simBuyers").value = 8;
                $("simSellers").value = 5;
                $("simRounds").value = 80;
                $("simDelay").value = 250;
                state.simulation.scenario = "market_shock";
                if ($("simScenario")) {
                    $("simScenario").value = "market_shock";
                }
                renderSimulation();
                flash("Stress preset loaded.", "warn");
            });
            $("btnResetSystem")?.addEventListener("click", resetPlayground);
        }

        function applyScenarioPreset(name, options = {}) {
            const { silent = false, applyInputs = true } = options;
            const preset = SCENARIO_PRESETS[name] || SCENARIO_PRESETS.baseline;

            state.simulation.scenario = name in SCENARIO_PRESETS ? name : "baseline";
            if (applyInputs) {
                $("simBuyers").value = preset.buyers;
                $("simSellers").value = preset.sellers;
                $("simRounds").value = preset.rounds;
                $("simDelay").value = preset.delay_ms;
            }

            const scenarioSelect = $("simScenario");
            if (scenarioSelect) {
                scenarioSelect.value = state.simulation.scenario;
            }
            setText("simScenarioName", preset.name);
            setText("simScenarioNotes", preset.notes);

            if (!silent) {
                flash(`Scenario applied: ${preset.name}.`, "ok");
            }
        }

        function saveSelectedAgentOverrides() {
            const agentId = state.selectedAgentId;
            if (!agentId) {
                flash("Select an agent first.", "warn");
                return;
            }

            const priority = $("agentPriorityOverride")?.value || "normal";
            const risk = $("agentRiskOverride")?.value || "auto";
            state.agentOverrides[agentId] = { priority, risk };
            persistAgentOverrides();
            renderAgents();
            renderDashboard();
            flash("Agent overrides saved.", "ok");
        }

        async function fundSelectedAgent() {
            const agentId = state.selectedAgentId;
            const usd = Number($("agentFundAmount")?.value || 0);
            if (!agentId) {
                flash("Select an agent first.", "warn");
                return;
            }
            if (usd <= 0) {
                flash("Funding amount must be greater than zero.", "warn");
                return;
            }

            try {
                await requestJSON(`/api/agents/${encodeURIComponent(agentId)}/fund`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ amount: Math.round(usd * 100) }),
                });
                flash(`Funded ${agentId} with ${formatMoney(Math.round(usd * 100))}.`, "ok");
                await Promise.allSettled([
                    loadAgents(),
                    loadStatus(),
                    loadSupply(),
                    loadLedger(),
                    loadTransactions(),
                ]);
                renderAll();
            } catch (error) {
                flash(`Funding failed: ${error.message}`, "bad");
            }
        }

        async function setSelectedAgentPresence(nextState) {
            const agentId = state.selectedAgentId;
            if (!agentId) {
                flash("Select an agent first.", "warn");
                return;
            }

            try {
                await requestJSON(`/api/agents/${encodeURIComponent(agentId)}/presence`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ state: nextState }),
                });
                flash(`Agent ${agentId} state set to ${nextState}.`, "ok");
                await Promise.allSettled([loadAgents(), loadStatus()]);
                renderAll();
            } catch (error) {
                flash(`Presence update failed: ${error.message}`, "bad");
            }
        }

        function bindFilterGroup(containerSelector, onChange) {
            const container = document.querySelector(containerSelector);
            if (!container) {
                return;
            }
            container.querySelectorAll(".chip").forEach((chip) => {
                chip.addEventListener("click", () => {
                    container.querySelectorAll(".chip").forEach((other) => {
                        other.classList.remove("active");
                    });
                    chip.classList.add("active");
                    onChange(chip.dataset.filter || "all");
                });
            });
        }

        function wireFilters() {
            bindFilterGroup("#dashboardEventFilters", (filter) => {
                state.dashboardEventFilter = filter;
                renderDashboardEvents();
            });
            bindFilterGroup("#auditEventFilters", (filter) => {
                state.auditEventFilter = filter;
                renderAuditEvents();
            });
            bindFilterGroup("#activityFilters", (filter) => {
                state.activityFilter = filter;
                renderActivityTable();
            });
        }

        async function initialLoad() {
            await Promise.allSettled([
                loadStatus(),
                loadInfo(),
                loadAgents(),
                loadResonators(),
                loadTransactions(),
                loadLedger(),
                loadSupply(),
                loadReceipts(),
                loadReceiptRecords(),
                loadActivity(),
            ]);
            state.lastRefreshAt = new Date();
            renderAll();
            flash("Control center loaded.", "ok");
        }

        async function heartbeatRefresh() {
            await Promise.allSettled([loadStatus(), loadAgents()]);
            if (state.tab === "operations" || state.tab === "dashboard") {
                await loadTransactions();
            }
            if (state.tab === "treasury") {
                await Promise.allSettled([loadLedger(), loadSupply()]);
            }
            if (state.tab === "audit") {
                await Promise.allSettled([loadActivity(), loadReceiptRecords()]);
            }
            state.lastRefreshAt = new Date();
            renderAll();
        }

        async function refreshDashboardData() {
            await Promise.allSettled([
                loadStatus(),
                loadAgents(),
                loadTransactions(),
                loadSupply(),
            ]);
            state.lastRefreshAt = new Date();
            renderDashboard();
            flash("Dashboard refreshed.", "ok");
        }

        async function loadForTab(tabName) {
            try {
                if (tabName === "dashboard") {
                    await refreshDashboardData();
                } else if (tabName === "agents") {
                    await Promise.allSettled([loadAgents(), loadResonators()]);
                    renderAgents();
                } else if (tabName === "operations") {
                    await Promise.allSettled([loadTransactions(), loadStatus()]);
                    renderOperations();
                } else if (tabName === "treasury") {
                    await Promise.allSettled([loadLedger(), loadSupply(), loadReceipts()]);
                    renderTreasury();
                } else if (tabName === "audit") {
                    await Promise.allSettled([loadActivity(), loadInfo(), loadStatus(), loadReceiptRecords()]);
                    renderAudit();
                } else if (tabName === "simulation") {
                    renderSimulation();
                }
            } catch (error) {
                flash(`Tab load issue: ${error.message}`, "bad");
            }
        }

        async function loadStatus() {
            state.status = await requestJSON("/api/status");
            setText("sysVersion", state.status?.version || "0.1.0");
        }

        async function loadInfo() {
            state.info = await requestJSON("/api/info");
        }

        async function loadAgents() {
            const data = await requestJSON("/api/agents");
            state.agents = data?.agents || [];
            if (!state.selectedAgentId && state.agents.length > 0) {
                state.selectedAgentId = state.agents[0].id;
            }
            const exists = state.agents.some((agent) => agent.id === state.selectedAgentId);
            if (!exists) {
                state.selectedAgentId = state.agents[0]?.id || null;
            }
            populateTradeSelectors();
            if (state.selectedAgentId) {
                await loadAgentActivity(state.selectedAgentId);
                await loadAgentTrace(state.selectedAgentId);
            }
        }

        async function loadResonators() {
            const data = await requestJSON("/api/resonators");
            state.resonators = data?.resonators || [];
        }

        async function loadAgentActivity(agentId) {
            if (!agentId) {
                return;
            }
            const data = await requestJSON(`/api/agents/${encodeURIComponent(agentId)}/activity`);
            state.agentActivity[agentId] = data?.entries || [];
        }

        async function loadAgentTrace(agentId) {
            if (!agentId) {
                return;
            }
            const data = await requestJSON(`/api/agents/${encodeURIComponent(agentId)}/kernel-trace`);
            state.agentTrace[agentId] = data?.events || [];
        }

        function downloadKernelTrace() {
            const agentId = state.selectedAgentId;
            if (!agentId) {
                flash("Select an agent to download kernel trace.", "warn");
                return;
            }
            const url = `/api/agents/${encodeURIComponent(agentId)}/kernel-trace?download=1`;
            window.open(url, "_blank");
        }

        async function loadTransactions() {
            const data = await requestJSON("/api/transactions");
            state.transactions = data?.transactions || [];
        }

        async function loadLedger() {
            state.ledger = await requestJSON("/api/ledger/accounts");
        }

        async function loadSupply() {
            state.supply = await requestJSON("/api/issuer/supply");
        }

        async function loadReceipts() {
            const data = await requestJSON("/api/issuer/receipts");
            state.receipts = data?.receipts || [];
        }

        async function loadReceiptRecords() {
            const data = await requestJSON("/api/receipts");
            state.receiptRecords = data?.receipts || [];
        }

        async function verifyReceiptById(receiptId) {
            try {
                const data = await requestJSON("/api/receipts/verify", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ receipt_id: receiptId }),
                });
                const result = data?.result || {};
                setText("receiptVerifyResult", JSON.stringify(result, null, 2));
                flash(`Receipt ${shortId(receiptId, 12)} ${result.valid ? "valid" : "invalid"}.`, result.valid ? "ok" : "warn");
            } catch (error) {
                setText("receiptVerifyResult", `Verification failed: ${error.message}`);
                flash(`Receipt verification failed: ${error.message}`, "bad");
            }
        }

        function verifyReceiptManual() {
            const receiptId = $("receiptVerifyInput")?.value?.trim();
            if (!receiptId) {
                flash("Enter a receipt id to verify.", "warn");
                return;
            }
            verifyReceiptById(receiptId);
        }

        function downloadReceipts() {
            window.open("/api/receipts/export", "_blank");
        }

        async function loadReceiptExport() {
            try {
                const resp = await fetch("/api/receipts/export");
                if (!resp.ok) {
                    throw new Error(`Export failed (${resp.status})`);
                }
                const text = await resp.text();
                $("receiptReplayInput").value = text;
                flash("Receipt export loaded.", "ok");
            } catch (error) {
                flash(`Export load failed: ${error.message}`, "bad");
            }
        }

        async function replayReceiptBundle() {
            const payload = $("receiptReplayInput")?.value || "";
            if (!payload.trim()) {
                flash("Paste receipt JSONL first.", "warn");
                return;
            }
            try {
                const response = await fetch("/api/receipts/replay", {
                    method: "POST",
                    headers: { "Content-Type": "text/plain" },
                    body: payload,
                });
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data?.message || "Replay failed");
                }
                setText("receiptReplayResult", JSON.stringify(data, null, 2));
                flash("Receipt replay completed.", "ok");
            } catch (error) {
                setText("receiptReplayResult", `Replay failed: ${error.message}`);
                flash(`Replay failed: ${error.message}`, "bad");
            }
        }

        async function loadActivity() {
            const data = await requestJSON("/api/system/log");
            state.activity = data?.entries || [];
        }

        function connectSSE() {
            if (state.eventSource) {
                state.eventSource.close();
            }

            state.eventSource = new EventSource("/api/events");

            state.eventSource.onopen = () => {
                setDot("dotConnection", "ok");
                setText("txtConnection", "Connected");
            };

            state.eventSource.onerror = () => {
                setDot("dotConnection", "bad");
                setText("txtConnection", "Disconnected");
                setTimeout(connectSSE, 3000);
            };

            SSE_EVENTS.forEach((eventName) => {
                state.eventSource.addEventListener(eventName, (event) => handleSseEvent(eventName, event.data));
            });
        }

        function eventCategoryFromName(name) {
            if ([
                "trade_started",
                "trade_completed",
                "ledger_entry",
                "escrow_event",
                "issuer_event",
                "transfer_proposed",
                "transfer_posted",
                "escrow_opened",
                "escrow_released",
                "minted",
                "burned",
            ].includes(name)) {
                return "trade";
            }
            if (["trade_failed", "dispute_event", "commitment_rejected", "attention_exhausted", "capability_denied"].includes(name)) {
                return "risk";
            }
            if (["llm_reasoning", "attention_allocated", "capability_granted"].includes(name)) {
                return "ai";
            }
            if ([
                "maple_runtime",
                "coupling_established",
                "coupling_strengthened",
                "coupling_weakened",
                "decoupled",
                "commitment_submitted",
                "commitment_declared",
                "commitment_approved",
                "commitment_outcome",
            ].includes(name)) {
                return "maple";
            }
            return "system";
        }

        function summarizeEvent(name, payload) {
            switch (name) {
                case "agent_created":
                    return `Agent created: ${payload.name || payload.agent_id} (${payload.role || "unknown"})`;
                case "trade_started":
                    return `Trade opened: ${payload.service_name || "service"} ${formatMoney(payload.amount)}`;
                case "trade_completed":
                    return `Trade settled: ${payload.service_name || "service"} ${formatMoney(payload.amount)}`;
                case "trade_failed":
                    return `Trade failed: ${payload.reason || "unknown"}`;
                case "commitment_declared":
                    return `Commitment declared ${shortId(payload.commitment_id, 12)} for ${formatMoney(payload.amount)}`;
                case "llm_reasoning":
                    return `LLM: ${payload.agent_name || payload.agent_id} ${payload.action || "reasoning"}`;
                case "balance_updated":
                    return `Balance update: ${payload.agent_name || payload.agent_id} -> ${formatMoney(payload.new_balance)}`;
                case "receipt_generated":
                    return `Receipt generated: ${payload.receipt_type || "receipt"} by ${payload.actor || "system"}`;
                case "receipt_issued":
                    return `Receipt issued: ${payload.receipt_type || "receipt"} by ${payload.actor || "system"}`;
                case "receipt_verified":
                    return `Receipt verified: ${payload.valid ? "valid" : "invalid"}`;
                case "issuer_event":
                    return `Issuer ${payload.event_type || "event"}: ${formatMoney(payload.amount)}`;
                case "minted":
                    return `Minted: ${formatMoney(payload.amount)} to ${payload.account || "account"}`;
                case "burned":
                    return `Burned: ${formatMoney(payload.amount)} from ${payload.account || "account"}`;
                case "escrow_event":
                    return `Escrow ${payload.state || "update"}: ${formatMoney(payload.amount)}`;
                case "escrow_opened":
                    return `Escrow opened ${shortId(payload.escrow_id, 12)}: ${formatMoney(payload.amount)}`;
                case "escrow_released":
                    return `Escrow released ${shortId(payload.escrow_id, 12)}: ${formatMoney(payload.amount)}`;
                case "transfer_proposed":
                    return `Transfer proposed: ${formatMoney(payload.amount)} ${shortId(payload.from, 8)}  ${shortId(payload.to, 8)}`;
                case "transfer_posted":
                    return `Transfer posted: ${formatMoney(payload.amount)} ${shortId(payload.from, 8)}  ${shortId(payload.to, 8)}`;
                case "maple_runtime":
                    return `Runtime: ${payload.description || payload.event_type || "event"}`;
                case "coupling_established":
                    return `Coupling established ${shortId(payload.coupling_id, 12)} strength ${Number(payload.strength || 0).toFixed(2)}`;
                case "coupling_strengthened":
                    return `Coupling strengthened ${shortId(payload.coupling_id, 12)} to ${Number(payload.new_strength || 0).toFixed(2)}`;
                case "coupling_weakened":
                    return `Coupling weakened ${shortId(payload.coupling_id, 12)} to ${Number(payload.new_strength || 0).toFixed(2)}`;
                case "decoupled":
                    return `Decoupled ${shortId(payload.coupling_id, 12)} (${payload.reason || "completed"})`;
                case "commitment_submitted":
                    return `Commitment submitted ${shortId(payload.commitment_id, 12)} for ${formatMoney(payload.amount)}`;
                case "commitment_approved":
                    return `Commitment approved ${shortId(payload.commitment_id, 12)}`;
                case "commitment_rejected":
                    return `Commitment rejected ${shortId(payload.commitment_id, 12)}: ${payload.reason || "policy"}`;
                case "commitment_outcome":
                    return `Commitment outcome ${shortId(payload.commitment_id, 12)}: ${payload.success ? "success" : "failure"}`;
                case "system_reset":
                    return "System reset triggered.";
                default:
                    return `${name.replaceAll("_", " ")}: ${payload?.description || payload?.event_type || "update"}`;
            }
        }

        function handleSseEvent(name, rawData) {
            let payload = {};
            try {
                payload = JSON.parse(rawData || "{}");
            } catch (_) {
                payload = {};
            }

            if (name === "state_sync") {
                const summary = payload?.data;
                if (summary) {
                    applySummaryFromStateSync(summary);
                    renderAll();
                }
                return;
            }

            if (name === "system_reset") {
                state.simulation.running = false;
            }

            const item = {
                category: eventCategoryFromName(name),
                type: name,
                message: summarizeEvent(name, payload),
                timestamp: payload?.timestamp || new Date().toISOString(),
            };

            state.events.unshift(item);
            if (state.events.length > 300) {
                state.events.length = 300;
            }

            renderDashboardEvents();
            renderAuditEvents();
            renderSimulation();

            scheduleRefreshFromEvent(name);
        }

        function applySummaryFromStateSync(summary) {
            const previous = state.status || {};
            state.status = {
                ...previous,
                maple_runtime: summary.runtime || previous.maple_runtime,
                agents: {
                    total: summary.agent_count,
                    buyers: summary.buyer_count,
                    sellers: summary.seller_count,
                    arbiters: summary.arbiter_count,
                },
                trading: {
                    trade_count: summary.trade_count,
                    total_volume: summary.total_volume,
                    total_volume_display: formatMoney(summary.total_volume),
                },
                issuer: {
                    total_supply: summary.total_supply,
                    remaining_supply: summary.remaining_supply,
                    total_supply_display: formatMoney(summary.total_supply),
                    remaining_supply_display: formatMoney(summary.remaining_supply),
                },
                uptime_seconds: summary.uptime_seconds,
                started_at: summary.started_at,
                maple_accountability: summary.maple_accountability,
                maple_couplings: summary.maple_couplings,
                maple_commitments: summary.maple_commitments,
            };
        }

        function scheduleRefreshFromEvent(name) {
            const important = [
                "agent_created",
                "trade_completed",
                "trade_failed",
                "system_reset",
                "issuer_event",
                "minted",
                "burned",
                "transfer_posted",
                "balance_updated",
                "agent_state_changed",
                "commitment_approved",
                "commitment_rejected",
            ];
            if (!important.includes(name)) {
                return;
            }
            clearTimeout(state.refreshTimer);
            state.refreshTimer = setTimeout(async () => {
                try {
                    await Promise.allSettled([
                        loadStatus(),
                        loadAgents(),
                        loadTransactions(),
                        loadSupply(),
                        loadLedger(),
                        loadReceipts(),
                    ]);
                    if (state.tab === "audit") {
                        await loadActivity();
                    }
                    state.lastRefreshAt = new Date();
                    renderAll();
                } catch (error) {
                    flash(`Refresh issue: ${error.message}`, "bad");
                }
            }, 550);
        }

        function populateTradeSelectors() {
            const buyers = state.agents.filter((agent) => String(agent.role) === "Buyer");
            const sellers = state.agents.filter((agent) => String(agent.role) === "Seller");

            const buyerSelect = $("tradeBuyer");
            const sellerSelect = $("tradeSeller");
            if (!buyerSelect || !sellerSelect) {
                return;
            }

            const prevBuyer = buyerSelect.value;
            const prevSeller = sellerSelect.value;

            buyerSelect.innerHTML = `<option value="">Select buyer</option>${buyers
                .map((buyer) => `<option value="${escapeHtml(buyer.id)}">${escapeHtml(buyer.name)} (${formatMoney(buyer.balance)})</option>`)
                .join("")}`;

            sellerSelect.innerHTML = `<option value="">Select seller</option>${sellers
                .map((seller) => {
                    const service = seller.services?.[0];
                    const serviceText = service ? `${service.name} ${formatMoney(service.price)}` : "No service";
                    return `<option value="${escapeHtml(seller.id)}">${escapeHtml(seller.name)} - ${escapeHtml(serviceText)}</option>`;
                })
                .join("")}`;

            buyerSelect.value = buyers.some((buyer) => buyer.id === prevBuyer) ? prevBuyer : "";
            sellerSelect.value = sellers.some((seller) => seller.id === prevSeller) ? prevSeller : "";
        }

        function renderAll() {
            renderHeader();
            renderDashboard();
            renderAgents();
            renderOperations();
            renderTreasury();
            renderAudit();
            renderSimulation();
        }

        function renderHeader() {
            const runtime = state.status?.maple_runtime;
            const llmAvailable = Boolean(state.status?.llm_available);
            const llmProvider = state.status?.llm_provider || "deterministic";
            const uptime = state.status?.uptime_seconds || 0;

            setText("txtRuntime", runtime?.is_running ? `${runtime.instance_name || "runtime"}` : "Runtime offline");
            setText("txtLLM", llmAvailable ? `LLM ${llmProvider}` : "LLM deterministic mode");
            setText("txtUptime", `Uptime ${formatDuration(uptime)}`);

            setDot("dotRuntime", runtime?.is_running ? "ok" : "warn");
            setDot("dotLLM", llmAvailable ? "ok" : "warn");
        }

        function renderDashboard() {
            const agents = state.agents;
            const buyers = agents.filter((agent) => String(agent.role) === "Buyer").length;
            const sellers = agents.filter((agent) => String(agent.role) === "Seller").length;
            const completed = state.transactions.filter((tx) => String(tx.status) === "Completed").length;
            const failed = state.transactions.filter((tx) => String(tx.status) === "Failed").length;
            const totalTrades = state.transactions.length;
            const totalVolume = state.transactions.reduce((sum, tx) => sum + Number(tx.amount || 0), 0);
            const successRate = completed + failed > 0 ? (completed / (completed + failed)) * 100 : 100;
            const avgTicket = totalTrades > 0 ? totalVolume / totalTrades : 0;

            setText("kpiAgents", formatNumber(agents.length));
            setText("kpiAgentsSplit", `${buyers} buyers / ${sellers} sellers`);
            setText("kpiTrades", formatNumber(completed));
            setText("kpiSuccessRate", `Success ${successRate.toFixed(1)}%`);
            setText("kpiVolume", formatMoney(totalVolume));
            setText("kpiAvgTicket", `Avg ticket ${formatMoney(avgTicket)}`);

            setText("kpiSupply", state.supply?.total_display || state.status?.issuer?.total_supply_display || "$0.00");
            setText("kpiSupplyRemaining", `Remaining ${state.supply?.remaining_display || state.status?.issuer?.remaining_supply_display || "$0.00"}`);

            const couplings = state.status?.maple_couplings;
            const commitments = state.status?.maple_commitments;
            const runtime = state.status?.maple_runtime;

            setText("kpiCouplings", formatNumber(couplings?.active_count || 0));
            setText("kpiCommitments", `Commitments ${formatNumber(commitments?.total || 0)}`);
            setText("kpiRuntime", runtime?.is_running ? "Running" : "Idle");
            setText("kpiRuntimeNote", `Uptime ${formatDuration(state.status?.uptime_seconds || 0)}`);

            const features = runtime?.features || [];
            const pending = Number(state.status?.maple_accountability?.pending_reviews || 0);
            const success = Number(state.status?.maple_accountability?.successful_executions || 0);
            const fail = Number(state.status?.maple_accountability?.failed_executions || 0);
            const execTotal = success + fail;
            const execRate = execTotal > 0 ? (success / execTotal) * 100 : 0;

            setText("riskFailClosed", features.includes("fail_closed") ? "Enforced" : "Unknown");
            setText("riskNoHuman", features.includes("no_human_profiles") ? "Enforced" : "Unknown");
            setText("riskPending", formatNumber(pending));
            setText("riskExecSuccess", `${execRate.toFixed(1)}%`);
            setText("riskCouplings", formatNumber(couplings?.active_count || 0));
            setText("riskReserve", state.supply?.remaining_display || state.status?.issuer?.remaining_supply_display || "$0.00");

            const featureText = features.length > 0
                ? `Runtime features: ${features.join(", ")}`
                : "Runtime features not reported yet.";
            setText("runtimeFeatureSummary", featureText);

            setText("sysLlmProvider", state.status?.llm_provider || "none");
            setText("sysRuntimeProfile", runtime?.profile || "- ");
            setText("sysResonators", `${formatNumber(runtime?.resonator_count || 0)} / ${formatNumber(runtime?.max_resonators || 0)}`);
            setText("sysLastRefresh", state.lastRefreshAt ? state.lastRefreshAt.toLocaleTimeString() : "-");

            renderLiquidityBoard();
            renderDashboardCharts();
            renderDashboardEvents();
        }

        function renderLiquidityBoard() {
            const container = $("dashboardAgentBoard");
            if (!container) {
                return;
            }

            if (state.agents.length === 0) {
                container.innerHTML = '<div class="empty">No agents yet. Create agents or start simulation to populate liquidity board.</div>';
                return;
            }

            const sorted = [...state.agents]
                .sort((a, b) => Number(b.balance || 0) - Number(a.balance || 0))
                .slice(0, 10);
            const maxBalance = Math.max(...sorted.map((agent) => Number(agent.balance || 0)), 1);

            container.innerHTML = sorted.map((agent) => {
                const pct = Math.max(4, Math.round((Number(agent.balance || 0) / maxBalance) * 100));
                const risk = riskFromAgent(agent);
                return `
                    <div class="liquidity-item">
                        <div class="liq-top">
                            <div>
                                <div class="liq-name">${escapeHtml(agent.name)} <span class="tag ${roleClass(agent.role)}">${escapeHtml(String(agent.role))}</span></div>
                                <div class="liq-meta">${escapeHtml(agent.id)} | trades ${formatNumber(agent.trade_count || 0)} | <span class="tag risk-${risk}">${risk.toUpperCase()}</span></div>
                            </div>
                            <div class="liq-value">${formatMoney(agent.balance)}</div>
                        </div>
                        <div class="bar-track"><div class="bar-fill" style="width:${pct}%"></div></div>
                    </div>
                `;
            }).join("");
        }

        function renderDashboardCharts() {
            renderVolumeTrendChart();
            renderBalanceSpreadChart();
            renderPresenceMixChart();
        }

        function renderVolumeTrendChart() {
            const container = $("chartVolumeTrend");
            if (!container) {
                return;
            }
            const recent = [...state.transactions]
                .slice(0, 24)
                .reverse();
            if (recent.length === 0) {
                container.innerHTML = '<div class="empty">No completed trades yet.</div>';
                setText("chartVolumeMeta", "No trade data yet.");
                return;
            }

            const values = recent.map((tx) => Number(tx.amount || 0));
            const maxValue = Math.max(...values, 1);
            const minValue = Math.min(...values, 0);
            const w = 520;
            const h = 120;
            const pad = 14;
            const xSpan = Math.max(1, values.length - 1);

            const points = values.map((value, index) => {
                const x = pad + (index / xSpan) * (w - pad * 2);
                const normalized = (value - minValue) / Math.max(1, maxValue - minValue);
                const y = h - pad - normalized * (h - pad * 2);
                return { x, y };
            });

            const linePath = points
                .map((p, idx) => `${idx === 0 ? "M" : "L"} ${p.x.toFixed(2)} ${p.y.toFixed(2)}`)
                .join(" ");
            const areaPath = `${linePath} L ${points[points.length - 1].x.toFixed(2)} ${h - pad} L ${points[0].x.toFixed(2)} ${h - pad} Z`;

            container.innerHTML = `
                <svg class="chart-svg" viewBox="0 0 ${w} ${h}" preserveAspectRatio="none" aria-label="Volume trend">
                    <defs>
                        <linearGradient id="volFill" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" stop-color="rgba(32,196,183,0.55)" />
                            <stop offset="100%" stop-color="rgba(32,196,183,0.06)" />
                        </linearGradient>
                    </defs>
                    <line x1="${pad}" y1="${h - pad}" x2="${w - pad}" y2="${h - pad}" stroke="rgba(142,167,206,0.35)" stroke-width="1" />
                    <path d="${areaPath}" fill="url(#volFill)"></path>
                    <path d="${linePath}" fill="none" stroke="rgba(32,196,183,0.95)" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"></path>
                    ${points.map((p) => `<circle cx="${p.x.toFixed(2)}" cy="${p.y.toFixed(2)}" r="1.6" fill="rgba(124,196,255,0.95)"></circle>`).join("")}
                </svg>
            `;

            const total = values.reduce((sum, value) => sum + value, 0);
            setText(
                "chartVolumeMeta",
                `Showing ${values.length} trades | Total ${formatMoney(total)} | Peak ${formatMoney(maxValue)}`
            );
        }

        function renderBalanceSpreadChart() {
            const container = $("chartBalanceSpread");
            if (!container) {
                return;
            }
            if (state.agents.length === 0) {
                container.innerHTML = '<div class="empty">No agent balances to compare.</div>';
                setText("chartBalanceMeta", "No balances yet.");
                return;
            }

            const top = [...state.agents]
                .sort((a, b) => Number(b.balance || 0) - Number(a.balance || 0))
                .slice(0, 6);
            const maxBalance = Math.max(...top.map((agent) => Number(agent.balance || 0)), 1);

            container.innerHTML = top.map((agent) => {
                const pct = Math.max(3, Math.round((Number(agent.balance || 0) / maxBalance) * 100));
                return `
                    <div style="margin-bottom:8px;">
                        <div style="display:flex;justify-content:space-between;gap:8px;font-size:0.72rem;color:var(--text-muted);margin-bottom:4px;">
                            <span>${escapeHtml(agent.name)}</span>
                            <span>${formatMoney(agent.balance)}</span>
                        </div>
                        <div class="bar-track"><div class="bar-fill" style="width:${pct}%"></div></div>
                    </div>
                `;
            }).join("");

            const totalBalances = state.agents.reduce((sum, agent) => sum + Number(agent.balance || 0), 0);
            setText(
                "chartBalanceMeta",
                `Top ${top.length} shown | Aggregate ${formatMoney(totalBalances)}`
            );
        }

        function renderPresenceMixChart() {
            const container = $("chartPresenceMix");
            if (!container) {
                return;
            }
            if (state.agents.length === 0) {
                container.innerHTML = '<div class="empty">No presence signals yet.</div>';
                setText("chartPresenceMeta", "No presence data yet.");
                return;
            }

            const counts = {};
            state.agents.forEach((agent) => {
                const key = String(agent.presence || "Idle");
                counts[key] = (counts[key] || 0) + 1;
            });

            const palette = {
                Idle: "rgba(124,196,255,0.9)",
                Trading: "rgba(65,209,122,0.9)",
                ThinkingLLM: "rgba(241,180,69,0.9)",
                WaitingEscrow: "rgba(159,178,212,0.9)",
                ResolvingDispute: "rgba(240,105,92,0.9)",
                Suspended: "rgba(240,105,92,0.95)",
            };

            const total = state.agents.length;
            const rows = Object.entries(counts).sort((a, b) => b[1] - a[1]);
            const stacked = rows.map(([name, count]) => {
                const pct = (count / total) * 100;
                const color = palette[name] || "rgba(142,167,206,0.9)";
                return `<span class="stack-segment" style="width:${pct}%;background:${color};"></span>`;
            }).join("");

            const legend = rows.map(([name, count]) => {
                const color = palette[name] || "rgba(142,167,206,0.9)";
                return `
                    <div class="legend-item">
                        <span class="legend-dot" style="background:${color};"></span>
                        <span>${escapeHtml(name)} (${count})</span>
                    </div>
                `;
            }).join("");

            container.innerHTML = `
                <div class="stack-track">${stacked}</div>
                <div class="legend-list">${legend}</div>
            `;

            const suspended = counts.Suspended || 0;
            setText(
                "chartPresenceMeta",
                `Tracked ${total} agents | Suspended ${suspended} | Dominant ${rows[0]?.[0] || "Idle"}`
            );
        }

        function renderEventsInto(containerId, filter, maxItems = 40) {
            const container = $(containerId);
            if (!container) {
                return;
            }

            const filtered = state.events
                .filter((event) => filter === "all" || event.category === filter)
                .slice(0, maxItems);

            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty">No events match the active filter.</div>';
                return;
            }

            container.innerHTML = filtered.map((event) => `
                <div class="event-item ${escapeHtml(event.category)}">
                    <div class="event-head">
                        <span class="event-kind">${escapeHtml(event.type.replaceAll("_", " "))}</span>
                        <span class="event-time">${escapeHtml(formatTime(event.timestamp))}</span>
                    </div>
                    <div class="event-msg">${escapeHtml(event.message)}</div>
                </div>
            `).join("");
        }

        function renderDashboardEvents() {
            renderEventsInto("dashboardEventFeed", state.dashboardEventFilter, 35);
        }

        function renderAuditEvents() {
            renderEventsInto("auditEventFeed", state.auditEventFilter, 80);
        }

        function renderAgents() {
            const buyers = state.agents.filter((agent) => String(agent.role) === "Buyer");
            const sellers = state.agents.filter((agent) => String(agent.role) === "Seller");
            const suspended = state.agents.filter((agent) => String(agent.presence) === "Suspended");

            setText("agentTotalCount", formatNumber(state.agents.length));
            setText("agentBuyerCount", formatNumber(buyers.length));
            setText("agentSellerCount", formatNumber(sellers.length));
            setText("agentSuspendedCount", formatNumber(suspended.length));

            renderAgentStatusTable();
            renderSelectedAgent();
        }

        function renderAgentStatusTable() {
            const tbody = $("agentStatusTable");
            if (!tbody) {
                return;
            }

            if (state.agents.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty">No agents registered yet.</td></tr>';
                return;
            }

            const rows = [...state.agents].sort((a, b) => Number(b.trade_count || 0) - Number(a.trade_count || 0));
            tbody.innerHTML = rows.map((agent) => {
                const service = agent.services?.[0];
                const serviceText = service ? `${service.name} ${formatMoney(service.price)}` : "-";
                const risk = riskFromAgent(agent);
                const priority = priorityFromAgent(agent);
                return `
                    <tr class="row-selectable ${agent.id === state.selectedAgentId ? "active" : ""}" data-agent-id="${escapeHtml(agent.id)}">
                        <td>
                            <div class="strong">${escapeHtml(agent.name)}</div>
                            <div class="mono">${escapeHtml(shortId(agent.id, 18))}</div>
                        </td>
                        <td><span class="tag ${roleClass(agent.role)}">${escapeHtml(String(agent.role))}</span></td>
                        <td><span class="tag ${presenceClass(agent.presence)}">${escapeHtml(String(agent.presence))}</span></td>
                        <td class="strong">${formatMoney(agent.balance)}</td>
                        <td>${formatNumber(agent.trade_count || 0)}</td>
                        <td>${escapeHtml(serviceText)}</td>
                        <td><span class="tag risk-${risk}">${risk.toUpperCase()}</span></td>
                        <td><span class="tag risk-medium">${escapeHtml(priority.toUpperCase())}</span></td>
                    </tr>
                `;
            }).join("");

            tbody.querySelectorAll("tr[data-agent-id]").forEach((row) => {
                row.addEventListener("click", async () => {
                    const agentId = row.dataset.agentId;
                    state.selectedAgentId = agentId;
                    await loadAgentActivity(agentId);
                    await loadAgentTrace(agentId);
                    renderAgents();
                });
            });
        }

        function renderSelectedAgent() {
            const agent = state.agents.find((item) => item.id === state.selectedAgentId);
            if (!agent) {
                setText("agentDetailName", "-");
                setText("agentDetailId", "-");
                setText("agentDetailRole", "-");
                setText("agentDetailPresence", "-");
                setText("agentDetailBalance", "-");
                setText("agentDetailLlm", "-");
                setText("agentDetailServices", "-");
                setText("agentDetailOverrideState", "Auto");
                $("agentActivityList").innerHTML = '<div class="empty">Select an agent to inspect activity.</div>';
                if ($("agentTraceStatus")) {
                    setText("agentTraceStatus", "Select an agent to load kernel trace.");
                }
                if ($("agentTraceList")) {
                    $("agentTraceList").innerHTML = '<div class="empty">Select an agent to inspect kernel trace.</div>';
                }
                return;
            }

            setText("agentDetailName", agent.name || "-");
            setText("agentDetailId", agent.id || "-");
            setText("agentDetailRole", agent.role || "-");
            setText("agentDetailPresence", agent.presence || "-");
            setText("agentDetailBalance", formatMoney(agent.balance));
            setText("agentDetailLlm", agent.llm_model || "deterministic");

            const serviceText = (agent.services || []).length > 0
                ? agent.services.map((service) => `${service.name} (${formatMoney(service.price)})`).join(" | ")
                : "No services";
            setText("agentDetailServices", serviceText);

            const override = state.agentOverrides[agent.id] || { priority: "normal", risk: "auto" };
            if ($("agentPriorityOverride")) {
                $("agentPriorityOverride").value = override.priority || "normal";
            }
            if ($("agentRiskOverride")) {
                $("agentRiskOverride").value = override.risk || "auto";
            }
            setText(
                "agentDetailOverrideState",
                `Priority ${String(override.priority || "normal").toUpperCase()} | Risk ${String(override.risk || "auto").toUpperCase()}`
            );

            const entries = state.agentActivity[agent.id] || [];
            const list = $("agentActivityList");
            if (!list) {
                return;
            }
            if (entries.length === 0) {
                list.innerHTML = '<div class="empty">No activity records for this agent yet.</div>';
                return;
            }

            list.innerHTML = entries.slice(0, 25).map((entry) => `
                <div class="activity-item">
                    <div class="activity-row">
                        <span class="activity-cat">${escapeHtml(String(entry.category || "Unknown"))}</span>
                        <span class="event-time">${escapeHtml(formatTime(entry.timestamp))}</span>
                    </div>
                    <div class="activity-desc">${escapeHtml(entry.description || "-")}</div>
                </div>
            `).join("");

            const traceEntries = state.agentTrace[agent.id] || [];
            const traceList = $("agentTraceList");
            if (traceList) {
                if (traceEntries.length === 0) {
                    traceList.innerHTML = '<div class="empty">No kernel trace events yet.</div>';
                } else {
                    traceList.innerHTML = traceEntries.slice(0, 25).map((entry) => `
                        <div class="trace-item">
                            <div class="activity-row">
                                <span class="trace-stage">${escapeHtml(String(entry.stage || "stage"))}</span>
                                <span class="event-time">${escapeHtml(formatTime(entry.timestamp))}</span>
                            </div>
                            <div class="trace-desc">${escapeHtml(entry.message || "-")}</div>
                        </div>
                    `).join("");
                }
            }
            if ($("agentTraceStatus")) {
                setText(
                    "agentTraceStatus",
                    traceEntries.length === 0
                        ? "No kernel trace loaded."
                        : `Loaded ${traceEntries.length} kernel trace events.`
                );
            }
        }

        function renderOperations() {
            const couplings = state.status?.maple_couplings;
            const commitments = state.status?.maple_commitments;
            const accountability = state.status?.maple_accountability;

            setText("opsCouplingActive", formatNumber(couplings?.active_count || 0));
            setText("opsCouplingTotal", `Total ${formatNumber(couplings?.total_count || 0)}`);
            setText("opsCommitTotal", formatNumber(commitments?.total || 0));
            setText("opsCommitPending", `Pending ${formatNumber(accountability?.pending_reviews || 0)}`);

            const success = Number(accountability?.successful_executions || 0);
            const fail = Number(accountability?.failed_executions || 0);
            const total = success + fail;
            const rate = total > 0 ? (success / total) * 100 : 0;
            setText("opsExecSuccess", `${rate.toFixed(1)}%`);
            setText("opsExecCounts", `${formatNumber(success)} success / ${formatNumber(fail)} fail`);

            renderTransactionsTable();
            renderCommitmentTable();
        }

        function renderTransactionsTable() {
            const tbody = $("txTable");
            if (!tbody) {
                return;
            }

            setText("txCount", formatNumber(state.transactions.length));

            if (state.transactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty">No transactions yet.</td></tr>';
                return;
            }

            const rows = [...state.transactions].slice(0, 120);
            tbody.innerHTML = rows.map((tx) => {
                const status = String(tx.status || "Unknown");
                const statusRisk = status === "Completed" ? "low" : status === "Failed" ? "high" : "medium";
                return `
                    <tr>
                        <td class="mono">${escapeHtml(shortId(tx.tx_id, 14))}</td>
                        <td>${escapeHtml(tx.buyer_id || "-")}</td>
                        <td>${escapeHtml(tx.seller_id || "-")}</td>
                        <td>${escapeHtml(tx.service_name || "-")}</td>
                        <td class="strong">${formatMoney(tx.amount)}</td>
                        <td><span class="tag risk-${statusRisk}">${escapeHtml(status)}</span></td>
                        <td class="nowrap">${escapeHtml(formatTime(tx.timestamp))}</td>
                    </tr>
                `;
            }).join("");
        }

        function renderCommitmentTable() {
            const tbody = $("commitmentTable");
            if (!tbody) {
                return;
            }

            const records = state.status?.maple_commitments?.recent || [];
            if (records.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty">No commitment records yet.</td></tr>';
                return;
            }

            tbody.innerHTML = records.slice(0, 40).map((record) => {
                const status = String(record.status || "Unknown");
                const risk = status === "Completed" || status === "Approved" ? "low" : status === "Failed" || status === "Rejected" ? "high" : "medium";
                return `
                    <tr>
                        <td class="mono">${escapeHtml(shortId(record.commitment_id, 14))}</td>
                        <td>${escapeHtml(record.buyer_name || "-")}</td>
                        <td>${escapeHtml(record.seller_name || "-")}</td>
                        <td class="strong">${formatMoney(record.amount)}</td>
                        <td><span class="tag risk-${risk}">${escapeHtml(status)}</span></td>
                    </tr>
                `;
            }).join("");
        }

        function renderTreasury() {
            setText("supplyTotal", state.supply?.total_display || "$0.00");
            setText("supplyRemaining", state.supply?.remaining_display || "$0.00");
            setText("supplyReceipts", formatNumber(state.supply?.receipt_count || 0));
            setText("entryCount", formatNumber(state.ledger?.total_entries || 0));

            renderLedgerAccounts();
            renderLedgerEntries();
            renderReceiptsTable();
        }

        function renderLedgerAccounts() {
            const tbody = $("ledgerAccounts");
            if (!tbody) {
                return;
            }
            const accounts = state.ledger?.accounts || [];
            if (accounts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="2" class="empty">No accounts available.</td></tr>';
                return;
            }
            tbody.innerHTML = accounts.map((account) => `
                <tr>
                    <td class="mono">${escapeHtml(account.account_id || "-")}</td>
                    <td class="strong">${escapeHtml(account.balance_display || formatMoney(account.balance))}</td>
                </tr>
            `).join("");
        }

        function renderLedgerEntries() {
            const tbody = $("ledgerEntries");
            if (!tbody) {
                return;
            }
            const entries = state.ledger?.recent_entries || [];
            if (entries.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty">No ledger entries yet.</td></tr>';
                return;
            }

            tbody.innerHTML = entries.map((entry) => {
                const type = String(entry.entry_type || "Unknown");
                const risk = type === "Credit" ? "low" : "medium";
                return `
                    <tr>
                        <td><span class="tag risk-${risk}">${escapeHtml(type)}</span></td>
                        <td class="mono">${escapeHtml(entry.account || "-")}</td>
                        <td class="strong">${escapeHtml(entry.amount_display || formatMoney(entry.amount))}</td>
                        <td>${formatMoney(entry.balance_after)}</td>
                        <td>${escapeHtml(String(entry.reason || "-"))}</td>
                    </tr>
                `;
            }).join("");
        }

        function renderReceiptsTable() {
            const tbody = $("receiptTable");
            if (!tbody) {
                return;
            }
            const receipts = state.receipts || [];
            setText("receiptCount", formatNumber(receipts.length));

            if (receipts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty">No issuer receipts yet.</td></tr>';
                return;
            }

            tbody.innerHTML = receipts.map((receipt) => `
                <tr>
                    <td class="mono">${escapeHtml(shortId(receipt.receipt_id, 16))}</td>
                    <td>${escapeHtml(String(receipt.operation || "-"))}</td>
                    <td class="mono">${escapeHtml(receipt.target || "-")}</td>
                    <td class="strong">${escapeHtml(receipt.amount_display || formatMoney(receipt.amount))}</td>
                    <td>${escapeHtml(formatTime(receipt.issued_at))}</td>
                </tr>
            `).join("");
        }

        function renderReceiptTimeline() {
            const container = $("receiptTimeline");
            if (!container) {
                return;
            }
            const receipts = state.receiptRecords || [];
            if (receipts.length === 0) {
                container.innerHTML = '<div class="empty">No receipts yet.</div>';
                return;
            }

            const sorted = receipts
                .slice()
                .sort((a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime())
                .slice(0, 120);

            container.innerHTML = sorted.map((record) => `
                <div class="trace-item">
                    <div>
                        <div class="trace-title">${escapeHtml(record.description || record.receipt_type)}</div>
                        <div class="trace-meta">
                            ${escapeHtml(shortId(record.receipt_id, 16))}
                             ${escapeHtml(record.receipt_type || "-")}
                             ${escapeHtml(record.actor || "-")}
                             ${escapeHtml(formatTime(record.timestamp))}
                        </div>
                    </div>
                    <button class="btn-soft receipt-verify-btn" data-receipt-id="${escapeHtml(record.receipt_id)}">Verify</button>
                </div>
            `).join("");

            container.querySelectorAll(".receipt-verify-btn").forEach((btn) => {
                btn.addEventListener("click", () => {
                    const receiptId = btn.dataset.receiptId;
                    if (receiptId) {
                        verifyReceiptById(receiptId);
                    }
                });
            });
        }

        function renderAudit() {
            renderActivityTable();
            renderAuditEvents();
            renderReceiptTimeline();

            setText("infoName", state.info?.name || "-");
            setText("infoArchitecture", state.info?.architecture || "-");
            setText("infoHomepage", state.info?.homepage || "-");
            setText("infoRepository", state.info?.repository || "-");
            setText("infoLlmProvider", state.status?.llm_provider || "none");
            setText("infoStarted", formatDateTime(state.status?.started_at));
        }

        function renderActivityTable() {
            const tbody = $("activityTable");
            if (!tbody) {
                return;
            }

            let entries = state.activity || [];
            if (state.activityFilter !== "all") {
                entries = entries.filter((entry) => String(entry.category) === state.activityFilter);
            }

            if (entries.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty">No activity entries for selected filter.</td></tr>';
                return;
            }

            tbody.innerHTML = entries.slice(0, 120).map((entry) => `
                <tr>
                    <td class="mono nowrap">${escapeHtml(formatTime(entry.timestamp))}</td>
                    <td><span class="tag ${levelClass(entry.level)}">${escapeHtml(String(entry.level || "Info"))}</span></td>
                    <td><span class="tag risk-medium">${escapeHtml(String(entry.category || "-"))}</span></td>
                    <td class="mono">${escapeHtml(entry.source || "-")}</td>
                    <td>${escapeHtml(entry.description || "-")}</td>
                </tr>
            `).join("");
        }

        function renderSimulation() {
            setText("simState", state.simulation.running ? "Running" : "Idle");
            setText("simLastRun", state.simulation.lastRun ? formatDateTime(state.simulation.lastRun) : "-");

            const scenario = SCENARIO_PRESETS[state.simulation.scenario] || SCENARIO_PRESETS.baseline;
            setText("simScenarioName", scenario.name);
            setText("simScenarioNotes", scenario.notes);
            if ($("simScenario")) {
                $("simScenario").value = state.simulation.scenario;
            }

            if (state.simulation.config) {
                const cfg = state.simulation.config;
                setText("simLastConfig", `${cfg.buyers} buyers, ${cfg.sellers} sellers, ${cfg.rounds} rounds @ ${cfg.delay_ms}ms`);
            } else {
                setText("simLastConfig", "-");
            }

            const simEvents = state.events.filter((event) => ["trade", "risk", "maple"].includes(event.category));
            setText("simTradeEvents", formatNumber(simEvents.length));

            const tape = $("simEventFeed");
            if (!tape) {
                return;
            }
            if (simEvents.length === 0) {
                tape.innerHTML = '<div class="empty">Run a simulation to populate event tape.</div>';
                return;
            }

            tape.innerHTML = simEvents.slice(0, 45).map((event) => `
                <div class="event-item ${escapeHtml(event.category)}">
                    <div class="event-head">
                        <span class="event-kind">${escapeHtml(event.type.replaceAll("_", " "))}</span>
                        <span class="event-time">${escapeHtml(formatTime(event.timestamp))}</span>
                    </div>
                    <div class="event-msg">${escapeHtml(event.message)}</div>
                </div>
            `).join("");
        }

        async function createBuyer() {
            const name = $("inBuyerName").value.trim();
            const fundingUsd = Number($("inBuyerFunding").value || 0);

            if (!name) {
                flash("Please enter buyer name.", "warn");
                return;
            }
            if (fundingUsd <= 0) {
                flash("Buyer funding must be positive.", "warn");
                return;
            }

            try {
                await requestJSON("/api/agents/buyer", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        name,
                        funding: Math.round(fundingUsd * 100),
                    }),
                });
                $("inBuyerName").value = "";
                flash(`Buyer ${name} created.`, "ok");
                await Promise.allSettled([loadAgents(), loadStatus()]);
                renderAll();
            } catch (error) {
                flash(`Buyer creation failed: ${error.message}`, "bad");
            }
        }

        async function createSeller() {
            const name = $("inSellerName").value.trim();
            const serviceName = $("inServiceName").value.trim();
            const servicePriceUsd = Number($("inServicePrice").value || 0);

            if (!name || !serviceName) {
                flash("Please enter seller and service names.", "warn");
                return;
            }
            if (servicePriceUsd <= 0) {
                flash("Service price must be positive.", "warn");
                return;
            }

            try {
                await requestJSON("/api/agents/seller", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        name,
                        service_name: serviceName,
                        price: Math.round(servicePriceUsd * 100),
                    }),
                });
                $("inSellerName").value = "";
                $("inServiceName").value = "";
                flash(`Seller ${name} created.`, "ok");
                await Promise.allSettled([loadAgents(), loadStatus(), loadResonators()]);
                renderAll();
            } catch (error) {
                flash(`Seller creation failed: ${error.message}`, "bad");
            }
        }

        async function executeTrade() {
            const buyerId = $("tradeBuyer").value;
            const sellerId = $("tradeSeller").value;

            if (!buyerId || !sellerId) {
                flash("Select both buyer and seller for trade execution.", "warn");
                return;
            }

            try {
                await requestJSON("/api/trade", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ buyer_id: buyerId, seller_id: sellerId }),
                });
                flash("Trade execution request submitted.", "ok");
                await Promise.allSettled([loadTransactions(), loadAgents(), loadStatus(), loadLedger(), loadSupply()]);
                renderAll();
            } catch (error) {
                flash(`Trade execution failed: ${error.message}`, "bad");
            }
        }

        async function startAutoTrading() {
            const rounds = Number($("autoRounds").value || 0);
            const delayMs = Number($("autoDelay").value || 0);

            if (rounds <= 0 || delayMs <= 0) {
                flash("Rounds and delay must be positive.", "warn");
                return;
            }

            const buyers = state.agents.filter((agent) => String(agent.role) === "Buyer").length;
            const sellers = state.agents.filter((agent) => String(agent.role) === "Seller").length;
            if (buyers === 0 || sellers === 0) {
                flash("Need at least one buyer and one seller before auto trading.", "warn");
                return;
            }

            try {
                await requestJSON("/api/trade/auto", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ rounds, delay_ms: delayMs }),
                });
                flash(`Auto trading started for ${rounds} rounds.`, "ok");
            } catch (error) {
                flash(`Auto trading failed: ${error.message}`, "bad");
            }
        }

        async function runSimulation() {
            const scenario = $("simScenario")?.value || "baseline";
            const buyers = Number($("simBuyers").value || 0);
            const sellers = Number($("simSellers").value || 0);
            const rounds = Number($("simRounds").value || 0);
            const delayMs = Number($("simDelay").value || 0);

            if (buyers <= 0 || sellers <= 0 || rounds <= 0 || delayMs <= 0) {
                flash("Simulation inputs must be positive values.", "warn");
                return;
            }

            state.simulation.running = true;
            state.simulation.lastRun = new Date().toISOString();
            state.simulation.scenario = scenario in SCENARIO_PRESETS ? scenario : "baseline";
            state.simulation.config = { buyers, sellers, rounds, delay_ms: delayMs };
            renderSimulation();
            clearTimeout(state.simulationTimer);
            state.simulationTimer = setTimeout(() => {
                state.simulation.running = false;
                renderSimulation();
            }, rounds * delayMs + 2500);

            try {
                await requestJSON("/api/simulate", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ buyers, sellers, rounds, delay_ms: delayMs }),
                });
                flash(
                    `Simulation started (${SCENARIO_PRESETS[state.simulation.scenario].name}): ${buyers} buyers, ${sellers} sellers, ${rounds} rounds.`,
                    "ok"
                );
            } catch (error) {
                state.simulation.running = false;
                flash(`Simulation failed: ${error.message}`, "bad");
            }
        }

        async function runUalCommand() {
            const command = $("ualCommand").value.trim();
            if (!command) {
                flash("Enter a UAL or banking command first.", "warn");
                return;
            }

            try {
                const result = await requestJSON("/api/ual", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ command }),
                });
                $("ualResult").textContent = JSON.stringify(result, null, 2);
                flash("UAL command executed.", "ok");
            } catch (error) {
                $("ualResult").textContent = `Error: ${error.message}`;
                flash(`UAL execution failed: ${error.message}`, "bad");
            }
        }

        async function resetPlayground() {
            const confirmed = window.confirm("Reset all agents, trades, and simulation state?");
            if (!confirmed) {
                return;
            }
            try {
                await requestJSON("/api/reset", { method: "POST" });
                state.simulation.running = false;
                clearTimeout(state.simulationTimer);
                state.events = [];
                state.selectedAgentId = null;
                flash("Playground reset completed.", "warn");
                await initialLoad();
            } catch (error) {
                flash(`Reset failed: ${error.message}`, "bad");
            }
        }
    </script>
</body>
</html>
